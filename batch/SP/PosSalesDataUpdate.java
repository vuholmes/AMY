/** * Copyright (C) 2002 QR Retail Autotamation Sdn. Bhd. * All right reserved. * *//** * Synopsis: PosSalesDataUpdate  * * Written: Profit V7.0 Project Team: awkw.  2004 *  * Revised: Name/ Date.  * Awkw 2005-10-27 do not check selprmstSQL.SELL_PRC_DISC_FLAG() == 'Y' *                 Always use selprmstSQL.SELL_PRC()  * Awkw 2006-06-19 Added record type D * Awkw 2006-09-05 Updated while I am in AEON China * Awkw 2006-11-06 Added new column EXT_DISC_AMOUNT_TOT * Awkw 2006-12-27 // Aeon pos already provide the amount in -ve * Awkw 2006-12-31 CASH_TOT * Awkw 2007-01-08  * Hiew Chia Lin *    Sales Upload Program need to change to post to stridacc based on *    sales trans date if the trans date's mth end is not closed, *    otherwise use last day updated. *    This is because Sales upload perform after end of day. *    Pls correct live data in strimacc, stridacc. * Awkw 2007-01-20 * Awkw 2007-03-28 Classmst AUTO_PA *    slstxdetSQL.setITEM_GROUP(itemmstSQL.CLASS()); // Awkw 2007-03-28 * alvinsim 2010-03-01  a) changes for Sales File new Record Type E *                      b) added new field SLSCSHCLLT.EDITABLE * alvinsim 2010-03-11  a) changes made to getPaymentTransTypeRecE() to append  *                         the sales type ('SLS', 'RTN') at the end of each  *                         payment type * alvinsim 2010-03-15  changed updateSLSTXHDR() to set "PI_RND" into  *                      SLSTXHDR.ROUNDING_AMT * alvinsim 2010-03-16  changed calcAuthoriseDisc() to add in missing discount *                      types * alvinsim 2010-04-18  Added new method to update SLSCSHCLLT EDITABLE columns *                      to 'Y' for previous day's transaction  *                      (SYSCTL.LAST_DAY_UPDATED - 1) after updating all the  *                      records type A, B, C, D and E. * alvinsim 2010-05-31  removed SLSCSHCLLT.STORE_POS_TRANS where ever is used *                      because is dropped from the table * alvinsim 2010-06-27  additional checking when processing tender types *                         a) check credit card range *                         b) merchant code *                         c) glintf debit and credit account code * alvinsim 2010-06-28  a) fixed isValidPosTenderTrans() when checking credit *                         card no. range *                      b) changed updateSLSTXHDR() when setting MEMBER_CODE to *                         read from Record Type B instead of Record Type  * alvinsim 2010-07-02  set TAX_AMT from Sales file to SLSTXHDR.TAX_AMT * alvinsim 2010-07-03  set TRANS_NO from Sales file to SLSCSHDIFF.TRANS_NO * alvinsim 2010-07-14  Additional checking for Easy Payment transaction type * alvinsim 2010-07-18  Additional checking for Kawanku Credit Card to allow if *                      Credit Card No. starts with 428332 * alvinsim 2010-09-13  Revised checking for credit card tender types * alvinsim 2010-11-26  Fixed wrong date calculation when updating  *                      SLSCSHCLLTUPDATE.EDITABLE to 'N' in  *                      updateSlscshclltEditable(). * alvinsim 2011-01-14  Fixed wrong date calculation when updating  *                      SLSCSHCLLTUPDATE.EDITABLE to 'N' in  *                      updateSlscshclltEditable(). * alvinsim 2011-01-25  Added additional checking for credit card no. to check *                      credit card no. to be numeric input only. * alvinsim 2011-02-09  Fixed updateSlstxdet() to set SLSTXDET.UNIT_SELL to '0'  *                      when SLSTXDET.QTY_SOLD is '0'. * ryan     2012-12-04  Add CDO checking AU-SD002981732  * JoeMy 2015-01-21 GST PCR * JoeMy 2016-12-16 E-Money PCR * AlanHeng 2018-03-21 ACS E-Wallet and E-Money Member Recognition */package qrcom.PROFIT.batch.SP;import java.sql.*;import java.util.*;import qrcom.PROFIT.batch.EOD.EOMLockerStatus;import qrcom.PROFIT.batch.EOD.StatusWriter;import qrcom.PROFIT.batch.SP.flatfile.FfSlsPosInstanceMaker;import qrcom.PROFIT.batch.SP.flatfile.FfSlsPosIntf;import qrcom.PROFIT.files.info.*;import qrcom.PROFIT.files.info.logger.Prebookhdrlogger;import qrcom.PROFIT.files.transform.txtFileRead;import qrcom.PROFIT.shared.Acct.AcctInterface;import qrcom.PROFIT.shared.Utility.SellpriceReader;import qrcom.PROFIT.system.DBConvert;import qrcom.PROFIT.system.SYSSystemUser;import qrcom.PROFIT.shared.Utility.SellCostCalc;//added ladyimport qrcom.util.*;/** * This class read pos sales data (normally, it is a ASCII file) and update into * SLSTXHDR, SLSTXDET and SLSCSHDET. */public class PosSalesDataUpdate implements BaseInfo {	private static final String PROGRAM_VERSION = "2006-12-31 13:25 Aw Kien Woon";	private static final String CREDIT_CARD_PAYMENT_TYPE = "3";	private static final String EASY_PAYMENT_PAYMENT_TYPE = "8";	/*	 * JoeMy 2016-11-28 E-Voucher private static final String	 * VOUCHER_PAYMENT_TYPE = "7"; private static final String	 * PROMOTION_VOUCHER_PAYMENT_TYPE = "9"; private static final String	 * REDEMPTION_VOUCHER_PAYMENT_TYPE = "0"; private static final String	 * PROMOTION_E_VOUCHER_PAYMENT_TYPE = "A"; private static final String	 * PRODUCT_E_VOUCHER_PAYMENT_TYPE = "B"; private static final String	 * RECHARGE_ISSUED_E_VOUCHHER_PAYMENT_TYPE = "C";	 */	// A-Promotion E-voucher|B-Product E-voucher|C-Recharge issued E-voucher	private final static String PROMO_DISC = "00";	private final static String MEMBER_DISC = "01";	private final static String MIX_MATCH_DISC = "02";	private final static String TOTAL_RECEIPT_DISC = "03";	private final static String MANUAL_POS_DISC = "11";	private final static String STAFF_DISC = "12";	private final static String PERISHABLE_DISC = "13";	private final static String CASH_TRANS_GROUP = "C";	private final static String REC_E_PYMNT_TYPE_SALES = "SLS";	private final static String REC_E_PYMNT_TYPE_RETURN = "RTN";	private final static String REC_E_PYMNT_TYPE_SALES_CODE = "0012";	private final static String REC_E_PYMNT_TYPE_RETURN_CODE = "0312";	private final static String LAST_OPR = "SYS";	private final static String LAST_OPR_FUNCT = "SALES PROCESS";	private Connection conn = null;	private PreparedStatement pstmt = null;	private ResultSet rs = null;	private SysctlSQL sysctlSQL = null;	private StrmstSQL strmstSQL = null;	private CoysubmstSQL coysubmstSQL = null;	private ItemmstSQL itemmstSQL = null;	private ProfitvvSQL profitvvSQL = null;	private SbclsmstSQL sbclsmstSQL = null;	private ClassmstSQL classmstSQL = null;	private XbarcodeSQL xbarcodeSQL = null;	private SelprmstSQL selprmstSQL = null;	private SlstxhdrSQL slstxhdrSQL = null;	private SlstxdetSQL slstxdetSQL = null;	private SlstxerrSQL slstxerrSQL = null;	private SlscshdetSQL slscshdetSQL = null;	private SlscsherrSQL slscsherrSQL = null;	private SlscshdiffSQL slscshdiffSQL = null;	private SlstxacsSQL slstxacsSQL = null;	private TxtypmstSQL txtypmstSQL = null;	private SlscshclltSQL slscshclltSQL = null;	private MerchtmstSQL merchtmstSQL = null;	private XCrecdmstSQL xcrecdmstSQL = null;	private SlscshclltupdateSQL slscshclltupdateSQL = null;	private SlscshclltstrSQL slscshclltstrSQL = null;// added by maxx	// Ryan AU-SD002981732 2012-11-29	private CdohdrSQL cdohdrSQL = null;	// private CdodetSQL cdodetSQL = null;	// JoeMy 2015-01-21 GST PCR - startt	private SlsinvhdrSQL slsinvhdrSQL = null;	private SlsinvdetSQL slsinvdetSQL = null;	private SlsinvdettotSQL slsinvdettotSQL = null;	// JoeMy 2015-01-21 GST PCR - end	// WenTem 2015-12-23 breakset start	private PackhdrSQL packhdrSQL = null;	private PackdetSQL packdetSQL = null;	private ItemmstSQL innerItemmstSQL = null;	// WenTem 2015-12-23 breakset end	// Goxz 20170803 Pre-Booking - Start	private PrebookslsSQL prebookslsSQL = null;	private PrebookdepSQL prebookdepSQL = null;	private PrebookhdrSQL prebookhdrSQL = null;	private PrebookhdrSQL curr_prebookhdrSQL = null;	private Prebookhdrlogger prebookhdrlogger = null;	// Goxz 20170803 Pre-Booking - End        	// AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23 - Start        private EmoneyencrypanSQL emoneyencrypanSQL = null;        // AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23 - End        	private boolean updateHDR = false;	private String CDO_REC_TYPE = "";	private CdoblerrSQL cdoblerrSQL = null; // Amir AU-IM002035089 Blacklist CDO Number	private SellCostCalc sellCostCalc = null; // added lady	private SellpriceReader sellpriceReader = null;	private FfSlsPosInstanceMaker ffSlsPosInstanceMaker = null;	private FfSlsPosIntf ffSlsPosHdrRec = null;	private FfSlsPosIntf save_ffSlsPosHdrRec = null;	private FfSlsPosIntf ffSlsPosTypeARec = null;	private FfSlsPosIntf ffSlsPosTypeBRec = null;	private FfSlsPosIntf ffSlsPosTypeCRec = null;	private FfSlsPosIntf ffSlsPosTypeDRec = null;	private FfSlsPosIntf ffSlsPosTypeERec = null;	private FfSlsPosIntf ffSlsPosTypeFRec = null;	private FfSlsPosIntf ffSlsPosTypeGRec = null; // Goxz 20170803 Pre-Booking	private SYSSystemUser sysSystemUser = null;	private EOMLockerStatus eOMLockerStatus = null;	private txtFileRead fr = new txtFileRead();	private ArrayList err_msg = new ArrayList();	private ArrayList arrVoucherPaymentType = new ArrayList();	// keep the sequence number of the receipt's line items reset to zero when it is TypeB record	private int item_seq_no = 0;	private int tender_seq_no = 0;	// to indicate Record type A is being updated	private int updated_typeA_rec = 0;	private int g_item_seq_no = 0; // Goxz 20170803 Keep the sequence number of the receipt's lin items in G Type	private String SYSSkuMax = null;	private String TRNItemSales = null;	private String TRNItemSalesRet = null;	private String TRNCashTransType = null;	private String TRNCashRetTransType = null;	private String TRNAeonCreditCardTyp = null;	private String SYSSlsInvGenerator = null;	private String SYSPosUploadEncode = null;	private String SYSDefPosSlsInvDesc = null;	private String SYSImpAMYSpGST = null;	private String SYSAMYGSTEffDate = null;	private String SYSSellVATBefGST = null;	private String SYSBlockPATaxRelief = null;	private String SYSTaxReliefTaxCode = null;	private String SYSVoucherPaymentTyp = null;	private String SYSPrebookGenerator = null; // Goxz 20170803 Pre-Booking	// WenTem 2015-12-23 breakset start	private String PackItemFlag = null;	private String hdrPackItemFlag = "N";	// WenTem 2015-12-23 breakset end	private java.sql.Date posting_date = null;	private java.sql.Date pos_sales_trans_date = null;	private java.util.Date save_process_time = null; // for process timing only	// as the FfSlsPosTypeB does not contains QTY_TOT and PROMO_DISC_TOT thus, I have accumulate these figures from FfSlsPosTypeA	private double Qty_total = 0;	private double dblPROMO_DISC_TOT = 0;	private double dblSTAFF_DISC_TOT = 0;	private double dblAUTHORISE_DISC_TOT = 0;	private double dblTOTAL_RECEIPT_DISC_TOT = 0;	private double dblMEMBER_DISC_TOT = 0;	private double dblPOS_DISC_TOT = 0;	private double dblOTHER_DISC_TOT1 = 0;	private double dblOTHER_DISC_TOT2 = 0;	private double dblOTHER_DISC_TOT3 = 0;	private double dblEXEC_DISC_TOT = 0;	private double dblCARD_DISC_TOT = 0;	private double dblGROUP_DISC_TOT = 0; // added by stanley 2009-12-16	private double dblSTDD_DISC_TOT = 0; // added by stanley 2009-12-16	private double dblMFR_DISC_TOT = 0; // added by stanley 2009-12-16	private double dblMBR_AUTO_DISC_TOT = 0;	private double dblRTC_DISC_TOT = 0; // Goxz 2017-04-05 POS Member Registration(SRAM041988)-Phase 1	private double dblPWP_DISC_TOT = 0; // Goxz 2017-08-10 SRAM071321 PWP	private double dblDISC_1_TOT = 0; // Goxz 2017-08-10 SRAM071321 PWP	private double dblDISC_2_TOT = 0; // Goxz 2017-08-10 SRAM071321 PWP	private double dblDISC_3_TOT = 0; // Goxz 2017-08-10 SRAM071321 PWP	private double dblDISC_4_TOT = 0; // Goxz 2017-08-10 SRAM071321 PWP	private double dblDISC_5_TOT = 0; // Goxz 2017-08-10 SRAM071321 PWP	private double dblPAYMENT_TOT = 0;	private qrRound qrRound_GST = null; // added by lady	private qrRound qrRound = null; // added by lady	private int count = 0;	private boolean slstxhdr_exist = false;	private StatusWriter writer = null;	private AcctInterface acctInterface = null;	private PosSalesDataUpdate() {	} // Constructor	public PosSalesDataUpdate(Connection cn) throws SQLException {		this.conn = cn;		jbInit();	}	private void jbInit() throws SQLException {		sysctlSQL = new SysctlSQL(conn);		classmstSQL = new ClassmstSQL(conn);		itemmstSQL = new ItemmstSQL(conn);		xbarcodeSQL = new XbarcodeSQL(conn);		sellpriceReader = new SellpriceReader(conn);		selprmstSQL = new SelprmstSQL(conn);		profitvvSQL = new ProfitvvSQL(conn);		txtypmstSQL = new TxtypmstSQL(conn);		slstxhdrSQL = new SlstxhdrSQL(conn);		slstxdetSQL = new SlstxdetSQL(conn);		slstxerrSQL = new SlstxerrSQL(conn);		slscshdetSQL = new SlscshdetSQL(conn);		slscsherrSQL = new SlscsherrSQL(conn);		slscshdiffSQL = new SlscshdiffSQL(conn);		sbclsmstSQL = new SbclsmstSQL(conn);		coysubmstSQL = new CoysubmstSQL(conn);		slstxacsSQL = new SlstxacsSQL(conn);		slscshclltSQL = new SlscshclltSQL();		eOMLockerStatus = new EOMLockerStatus();		merchtmstSQL = new MerchtmstSQL(conn);		xcrecdmstSQL = new XCrecdmstSQL(conn);		slscshclltupdateSQL = new SlscshclltupdateSQL(conn);		slscshclltstrSQL = new SlscshclltstrSQL(conn);// added by maxx		sellCostCalc = new SellCostCalc(conn); // added lady		// Ryan AU-SD002981732 2012-11-29		cdohdrSQL = new CdohdrSQL(conn);		// cdodetSQL = new CdodetSQL(conn);		// Amir AU-IM002035089 Blacklist CDO Number		cdoblerrSQL = new CdoblerrSQL(conn);		// JoeMy 2015-01-21 GST PCR		slsinvhdrSQL = new SlsinvhdrSQL(conn);		slsinvdetSQL = new SlsinvdetSQL(conn);		slsinvdettotSQL = new SlsinvdettotSQL(conn);		// WenTem 2015-12-23 breakset		packhdrSQL = new PackhdrSQL(conn);		packdetSQL = new PackdetSQL(conn);		innerItemmstSQL = new ItemmstSQL(conn);		// Goxz 20170803 Pre-Booking - Start		prebookslsSQL = new PrebookslsSQL(conn);		prebookdepSQL = new PrebookdepSQL(conn);		prebookhdrSQL = new PrebookhdrSQL(conn);		curr_prebookhdrSQL = new PrebookhdrSQL(conn);		prebookhdrlogger = new Prebookhdrlogger(conn);		// Goxz 20170803 Pre-Booking - End                		// AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23 - Start		emoneyencrypanSQL = new EmoneyencrypanSQL(conn);		// AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23 - End	} // jbInit	private void initDefaultValue() throws SQLException {		ffSlsPosInstanceMaker = new FfSlsPosInstanceMaker(strmstSQL.STORE_COY());		ffSlsPosHdrRec = ffSlsPosInstanceMaker.getFfSlsPosHdrInstance();		save_ffSlsPosHdrRec = ffSlsPosInstanceMaker.getFfSlsPosHdrInstance();		ffSlsPosTypeARec = ffSlsPosInstanceMaker.getFfSlsPosTypeAInstance();		ffSlsPosTypeBRec = ffSlsPosInstanceMaker.getFfSlsPosTypeBInstance();		ffSlsPosTypeCRec = ffSlsPosInstanceMaker.getFfSlsPosTypeCInstance();		ffSlsPosTypeDRec = ffSlsPosInstanceMaker.getFfSlsPosTypeDInstance(); 		ffSlsPosTypeERec = ffSlsPosInstanceMaker.getFfSlsPosTypeEInstance();		ffSlsPosTypeFRec = ffSlsPosInstanceMaker.getFfSlsPosTypeFInstance(); // JoeMy 2015-01-21 GST PCR		ffSlsPosTypeGRec = ffSlsPosInstanceMaker.getFfSlsPosTypeGInstance(); // Goxz 20170803 Pre-Booking		sysSystemUser = new SYSSystemUser(strmstSQL.STORE_COY());		retrieveCoysubmst(strmstSQL.STORE_COY(), strmstSQL.STORE_COY_SUB());		SYSSkuMax = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSSkuMax");		TRNItemSales = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "TRNItemSales");		TRNItemSalesRet = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "TRNItemSalesRtn");		TRNCashTransType = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "TRNCashTransType");		TRNCashRetTransType = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "TRNCashRetTransType");		TRNAeonCreditCardTyp = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "TRNAeonCreditCardTyp");		// Ryan AU-SD002981732 2012-11-29		CDO_REC_TYPE = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSCDOSlsLevel");		// JoeMy 2015-01-21 GST PCR		SYSSlsInvGenerator = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSSlsInvGenerator");		SYSPosUploadEncode = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSPosUploadEncode");		SYSDefPosSlsInvDesc = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSDefPosSlsInvDesc");		SYSImpAMYSpGST = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSImpAMYSpGST");		SYSAMYGSTEffDate = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSAMYGSTEffDate");		SYSSellVATBefGST = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSSellVATBefGST");		// Derek 2015-05-22 Tax Relief function AMY		SYSBlockPATaxRelief = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSBlockPATaxRelief");		SYSTaxReliefTaxCode = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSTaxReliefTaxCode");		// JoeMy 2016-11-28 E-Voucher		SYSVoucherPaymentTyp = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSVoucherPaymentTyp");		if (SYSVoucherPaymentTyp != null				&& SYSVoucherPaymentTyp.trim().length() > 0) {			StringTokenizer stoken = new StringTokenizer(SYSVoucherPaymentTyp, ",");			while (stoken.hasMoreElements()) {				arrVoucherPaymentType.add((String) stoken.nextElement());			}		}		System.out.println("arrVoucherPaymentType size=" + arrVoucherPaymentType.size());		// End JoeMy 2016-11-28 E-Voucher		SYSPrebookGenerator = profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSPrebookGenerator"); // Goxz 20170803 Pre-Booking		acctInterface = new AcctInterface(conn, strmstSQL.STORE_COY());	}	public void process(java.sql.Date pos_trans_date, StrmstSQL strmst,			String path_filename) throws Exception {		save_process_time = new java.util.Date();		this.writeln("start=" + save_process_time.toString());		this.strmstSQL = strmst;		// added by lady		qrRound_GST = new qrRound(strmstSQL.STORE_COY(), sellCostCalc.QRROUND_GROUP_GST, conn);		qrRound = new qrRound(strmstSQL.STORE_COY(), "SALES", conn);		sellCostCalc.setQrRound(qrRound_GST);		initDefaultValue();		// This is to remove the time (HH:MM:SS) from the object		pos_sales_trans_date = qrMisc.parseSqlDate(pos_trans_date.toString(), "YYYY-MM-DD");		String month_per = eOMLockerStatus.getMonthPer(pos_sales_trans_date);		if (eOMLockerStatus.isEndOfMonthBeingDone(strmstSQL.STORE_COY_SUB(), month_per)) {			posting_date = sysctlSQL.LAST_DAY_UPDATED();		} else {			posting_date = qrMisc.parseSqlDate(pos_trans_date.toString(), "YYYY-MM-DD");		}		this.writeln("process " + path_filename);		this.run(path_filename);	}	public void run(String path_filename) throws Exception {		try {			sellpriceReader.setWriter(writer);			fr.open(path_filename);			while (fr != null && fr.readNextLine()) {				if (fr.txtLine().length() == 0) {					continue;				}				parsePOSData(fr.txtLine());				if ((++count % 1000) == 0) {					java.util.Date _dt = new java.util.Date();					this.writeln("processing line ... " + count);					long time_diff = _dt.getTime() - save_process_time.getTime();					long min = time_diff / (1000 * 60); // in min					long sec = (time_diff - (min * 1000 * 60)) / 1000;					this.writeln("time = " + _dt.toString() + "  min:sec=" + min + ":" + sec);					save_process_time = _dt;					conn.commit();				}			} // while			updateSlstxhdr_TOTAL_TENDER();			updateSlscshclltEditable();		} catch (Exception e) {			String err = e.getMessage();			err = err.replaceAll("java.lang.Exception:", " ");			err = err.replaceAll("java.sql.SQLException:", " ");			count = count + 1;			err = err + ", line at [" + Integer.toString(count) + "]";						e.printStackTrace();			System.out.println(e.getMessage());			throw new SQLException(err);		} finally {			if (fr != null) {				fr.close();			}			if (sellpriceReader != null) {				sellpriceReader.closeStatement();			}			this.writeln("Total number of line processed = " + count);		}	}	/**	 * Parses the Sales file record line for processing. The record line will be	 * processed based on its record type ('A', 'B', 'C', 'D', 'E' and 'T')	 * <p>	 * If the Sales Transaction header (SLSTXHDR) does not already exists, then	 * an empty record will be created and will be updated again after all the	 * 	 * detail records have been inserted.	 * <p>	 * Below is a list of the processes for each record type	 * <ul>	 * <li>Record Type A: Inserts/updates SLSTXDET. If not valid type A record,	 * insert/update SLSTXERR	 * <li>Record Type B: Updates SLSTXHDR	 * <li>Record Type C: Inserts/updates SLSCSHDET. If Payment type is 'Aeon	 * Credit Card', insert/update SLSTXACS. Insert/Update SLSCSHERR if payment	 * type is not valid.	 * <li>Record Type D: Inserts/updates SLSCSHDIFF	 * <li>Record Type E: Inserts/updates SLSCSHCLLT	 * <li>Record Type T: Do nothing	 * </ul>	 * 	 * @throws java.lang.Exception	 *             If exceptions occurred when inserting or updating records.	 * @param strRecline	 *            Record line from Sales file	 */	private void parsePOSData(String strRecline) throws Exception {		ffSlsPosHdrRec = ffSlsPosInstanceMaker.getFfSlsPosHdrInstance();		ffSlsPosHdrRec.parseRecLine(strRecline);		String pi_store = getStoreCode(ffSlsPosHdrRec.getString("PI_STORE"));		String pi_pos = ffSlsPosHdrRec.getString("PI_POS");		String pi_trans_no = ffSlsPosHdrRec.getString("PI_TRANS_NO");		String save_pi_store = getStoreCode(save_ffSlsPosHdrRec.getString("PI_STORE"));		// if one of the below criteria change, then create SLSTXHDR empty record		if (!pi_store.equals(save_pi_store)				|| !pi_pos.equals(save_ffSlsPosHdrRec.getString("PI_POS"))				|| !pi_trans_no.equals(save_ffSlsPosHdrRec.getString("PI_TRANS_NO"))) {			createSLSTXHDR_empty_record(ffSlsPosHdrRec);			dblPROMO_DISC_TOT = 0;			dblSTAFF_DISC_TOT = 0;			dblAUTHORISE_DISC_TOT = 0;			dblTOTAL_RECEIPT_DISC_TOT = 0;			dblMEMBER_DISC_TOT = 0;			dblPOS_DISC_TOT = 0;			dblOTHER_DISC_TOT1 = 0;			dblOTHER_DISC_TOT2 = 0;			dblOTHER_DISC_TOT3 = 0;			dblEXEC_DISC_TOT = 0;			dblCARD_DISC_TOT = 0;			dblGROUP_DISC_TOT = 0;			dblSTDD_DISC_TOT = 0;			dblMFR_DISC_TOT = 0;			dblMBR_AUTO_DISC_TOT = 0;			dblRTC_DISC_TOT = 0; // Goxz 2017-04-05 POS Member Registration(SRAM041988)-Phase 1			dblPWP_DISC_TOT = 0; // Goxz 20170810 SRAM071321 PWP			dblDISC_1_TOT = 0; // Goxz 20170810 SRAM071321 PWP			dblDISC_2_TOT = 0; // Goxz 20170810 SRAM071321 PWP			dblDISC_3_TOT = 0; // Goxz 20170810 SRAM071321 PWP			dblDISC_4_TOT = 0; // Goxz 20170810 SRAM071321 PWP			dblDISC_5_TOT = 0; // Goxz 20170810 SRAM071321 PWP			dblPAYMENT_TOT = 0;			Qty_total = 0;			item_seq_no = 0;			tender_seq_no = 0;			updated_typeA_rec = 0;			g_item_seq_no = 0; // Goxz 20170803 Per-Booking		}		save_ffSlsPosHdrRec = ffSlsPosHdrRec;		/** Item sales or return transaction */		if (ffSlsPosHdrRec.getString("PI_FORMAT").equals("A")) {			ffSlsPosTypeARec.parseRecLine(strRecline);			if (isValidPosDetailTrans(ffSlsPosTypeARec)) {				updateSLSTXDET(ffSlsPosTypeARec);			} else {				updateSLSTXERR();			}		}		/** Total transaction */		else if (ffSlsPosHdrRec.getString("PI_FORMAT").equals("B")) {			ffSlsPosTypeBRec.parseRecLine(strRecline);			updateSLSTXHDR(ffSlsPosTypeBRec);			// Goxz 20170803 Pre-Booking - Start			if (slstxhdrSQL.PRE_BOOK_NO() != null					&& slstxhdrSQL.PRE_BOOK_NO().trim().length() > 0) {				if (slstxhdrSQL.SALES_FLAG().equalsIgnoreCase("2")) // pre-booking sales (when receive deposit)				{					insertPREBOOKHDR(); // insert prebookhdr record from B type record if record does not exits (it suppose maintain by user)					insertPREBOOKDEP(); // insert prebookdep record from A Type record				} else if (slstxhdrSQL.SALES_FLAG().equalsIgnoreCase("3")) // confirm pre-booking sales (when customer pay full for booking item)				{					updatePREBOOKHDR("U"); // update					confirmPREBOOKSLS();					updatePREBOOKDEP("U");				} else if (slstxhdrSQL.SALES_FLAG().equalsIgnoreCase("4")) // cancel pre-booking sales (when customer refund)				{					updatePREBOOKHDR("R"); // refund					refundPREBOOKSLS();					updatePREBOOKDEP("R");				}			}			// Goxz 20170803 Pre-Booking - End                        			// AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23 - Start                        if(ffSlsPosTypeBRec.getString("PI_ENCRYPTED_PAN") != null && ffSlsPosTypeBRec.getString("PI_ENCRYPTED_PAN").trim().length() > 0)                        {                               updateEMONEYENCRYPAN(ffSlsPosTypeBRec);                        }                        // AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23 - End		}		/** Tender transaction */		else if (ffSlsPosHdrRec.getString("PI_FORMAT").equals("C")) {			ffSlsPosTypeCRec.parseRecLine(strRecline);			if (isValidPosTenderTrans(ffSlsPosTypeCRec)) {				updateSLSCSHDET(ffSlsPosTypeCRec);				if (ffSlsPosTypeCRec.getString("PI_PYMT_TYPE").equalsIgnoreCase(TRNAeonCreditCardTyp)) {					updateSLSTXACS(ffSlsPosTypeCRec);				}			} else {				updateSLSCSHERR(ffSlsPosTypeCRec);			}		}		/** Cash count */		else if (ffSlsPosHdrRec.getString("PI_FORMAT").equals("D")) {			ffSlsPosTypeDRec.parseRecLine(strRecline);			updateSLSCSHDIFF(ffSlsPosTypeDRec);		}		/** Tender count */		else if (ffSlsPosHdrRec.getString("PI_FORMAT").equals("E")) {			ffSlsPosTypeERec.parseRecLine(strRecline);			updateSLSCSHCLLT(ffSlsPosTypeERec);			updateSLSCSHCLLTUPDATE();		}		/** Sales Invoice */		else if (ffSlsPosHdrRec.getString("PI_FORMAT").equals("F")) {			// JoeMy 2015-01-21 GST PCR			ffSlsPosTypeFRec.parseRecLine(strRecline);			if (ffSlsPosTypeFRec.getString("PI_INV_NO") != null					&& ffSlsPosTypeFRec.getString("PI_INV_NO").trim().length() > 0) {				insertSLSINVHDR(ffSlsPosTypeFRec);				insertSLSINVDET();				insertSLSINVDETTOT();				updateSLSINVHDR();				updateSLSTXHDR_INVSLS();			}			if (ffSlsPosTypeFRec.getString("PI_REF_INV_NO") != null					&& ffSlsPosTypeFRec.getString("PI_REF_INV_NO").trim().length() > 0) {				updateSLSTXHDR_INVSLS_REFUND(ffSlsPosTypeFRec);			}		}		// Goxz 20170803 Pre-Booking - Start		/** Pre Booking */		else if (ffSlsPosHdrRec.getString("PI_FORMAT").equals("G")) {			ffSlsPosTypeGRec.parseRecLine(strRecline);			insertPREBOOKSLS(ffSlsPosTypeGRec);		}		// Goxz 20170803 Pre-Booking - End		/** Trailer */		else if (ffSlsPosHdrRec.getString("PI_FORMAT").equals("T")) {			// do nothing		}	} // parsePOSData	private boolean isValidPosDetailTrans(FfSlsPosIntf _ffSlsPosTypeARec)			throws Exception {		boolean bln = true;		String InnerSKU = ""; // added by WenTem 2015-12-23 breakset		err_msg.clear();		if (!isValidItemCode(_ffSlsPosTypeARec.getString("PI_SKU"), _ffSlsPosTypeARec.getString("PI_SALES_TYPE"), strmstSQL.STORE_CATEGORY())) {			err_msg.add("Invalid Short SKU/Barcode");			bln = false;		}		// WenTem 2015-12-23 breakset start		if (itemmstSQL.ITEM_PACK() != null				&& itemmstSQL.ITEM_PACK().equals("Y")) {			if (!isPackItem(itemmstSQL.SHORT_SKU()))				PackItemFlag = "N";			else {				if (!getPackInnerItem(itemmstSQL.SHORT_SKU())) {					err_msg.add("Selling Pack Item. Missing Inner Short SKU for " + itemmstSQL.SHORT_SKU() + ".");					bln = false;				} else {					InnerSKU = packdetSQL.SHORT_SKU();					if (!isValidInnerSku(InnerSKU)) {						err_msg.add("Selling Pack Item. Invalid Short SKU : " + InnerSKU);						bln = false;					} else {						itemmstSQL.setSHORT_SKU(InnerSKU);						itemmstSQL.getByKey();					}				}				PackItemFlag = "Y";			}		} else {			PackItemFlag = "N";		}		// WenTem 2015-12-23 breakset end		String pi_store = getStoreCode(_ffSlsPosTypeARec.getString("PI_STORE"));		if (pi_store.equals(strmstSQL.STORE()) == false) {			err_msg.add("The store number in the record does not match with " + "the processed store");			bln = false;		}		if (_ffSlsPosTypeARec.getString("PI_ATYPE").equals("0001")) {			;		} else if (_ffSlsPosTypeARec.getString("PI_ATYPE").equals("0301")) {			;		} else {			err_msg.add("Unknown PI_ATYPE = " + _ffSlsPosTypeARec.getString("PI_ATYPE"));			bln = false;		}		// Ryan AU-SD002981732 2012-12-13		String pi_cdo = "";		if (CDO_REC_TYPE.equals("H")) {			slstxhdrSQL.setCOY(strmstSQL.STORE_COY());			slstxhdrSQL.setCOY_SUB(strmstSQL.STORE_COY_SUB());			slstxhdrSQL.setSTORE(strmstSQL.STORE());			slstxhdrSQL.setSALES_TRANS_DATE(pos_sales_trans_date);			slstxhdrSQL.setSTORE_POS_NUMBER(_ffSlsPosTypeARec.getString("PI_POS"));			slstxhdrSQL.setSTORE_POS_TRANS(_ffSlsPosTypeARec.getString("PI_TRANS_NO"));			if (slstxhdrSQL.getByKey() > 0) {				if (slstxhdrSQL.CDO_NO().length() > 0) {					pi_cdo = slstxhdrSQL.CDO_NO();				} else {					pi_cdo = _ffSlsPosTypeARec.getString("PI_CDO_NO").trim();				}			}		} else if (CDO_REC_TYPE.equals("D")) {			pi_cdo = _ffSlsPosTypeARec.getString("PI_CDO_NO").trim();		}		if (pi_cdo.length() > 0) {			ResultSet rs = null;			PreparedStatement pstate = null;			// boolean proceed = false; //syukri 17-07-2013 OOM issue			try {				// do //syukri 17-07-2013 OOM issue				// { //syukri 17-07-2013 OOM issue				cdohdrSQL.setCOY(strmstSQL.STORE_COY());				cdohdrSQL.setCOY_SUB(strmstSQL.STORE_COY_SUB());				cdohdrSQL.setCDO_NO(pi_cdo);				if (cdohdrSQL.checkKeyExist() == 0) {					err_msg.add("CDO No. does not exist");					insertCdoBlacklistErrRecord(); // Amir AU-IM002035089 Blacklist CDO Number					bln = false;					// break; //syukri 17-07-2013 OOM issue				} else {					updateHDR = true;					// } //syukri 17-07-2013 OOM issue					int exist = 0;					String query = " SELECT COUNT(*) CNT FROM CDODET "							+ // syukri 17-07-2013 OOM issue							" WHERE COY = ? " + " AND COY_SUB = ? "							+ " AND CDO_NO = ? " + " AND SHORT_SKU = ? ";					if (pstate == null)						pstate = conn.prepareStatement(query);					pstate.setString(1, strmstSQL.STORE_COY());					pstate.setString(2, strmstSQL.STORE_COY_SUB());					pstate.setString(3, pi_cdo);					if (_ffSlsPosTypeARec.getString("PI_SALES_TYPE").equals("02")) {						pstate.setString(4, qrMisc.leftFillZero(qrMisc.trimFrontZero(_ffSlsPosTypeARec.getString("PI_SKU")), Integer.valueOf(SYSSkuMax).intValue()));					} else if (_ffSlsPosTypeARec.getString("PI_SALES_TYPE").equals("01")) {						pstate.setString(4, xbarcodeSQL.SHORT_SKU());					}					rs = pstate.executeQuery();					while (rs != null && rs.next()) {						exist = rs.getInt("CNT"); // syukri 17-07-2013 OOM issue					}					if (exist == 0) {						err_msg.add("Item does not exist in CDO");						bln = false;					}				} // while(proceed); //syukri 17-07-2013 OOM issue			} finally {				try {					if (rs != null)						rs.close();				} catch (Exception e) {				}				rs = null;				try {					if (pstate != null)						pstate.close();				} catch (Exception e) {				}				pstate = null;			}		}		return (bln);	}	// Amir AU-IM002035089 Blacklist CDO Number	private void insertCdoBlacklistErrRecord() throws SQLException {		cdoblerrSQL.setCOY(slstxhdrSQL.COY());		cdoblerrSQL.setCOY_SUB(slstxhdrSQL.COY_SUB());		cdoblerrSQL.setSTORE(slstxhdrSQL.STORE());		cdoblerrSQL.setSALES_TRANS_DATE(slstxhdrSQL.SALES_TRANS_DATE());		cdoblerrSQL.setSTORE_POS_NUMBER(slstxhdrSQL.STORE_POS_NUMBER());		cdoblerrSQL.setSTORE_POS_TRANS(slstxhdrSQL.STORE_POS_TRANS());		cdoblerrSQL.setSALES_SEQ(++item_seq_no);		cdoblerrSQL.setCDO_NO(cdohdrSQL.CDO_NO());		int check = cdoblerrSQL.getByKeyForUpdate();		cdoblerrSQL.setLAST_OPR(LAST_OPR);		cdoblerrSQL.setLAST_OPR_FUNCT(LAST_OPR_FUNCT);		if (check == 0)			cdoblerrSQL.insert();		else			cdoblerrSQL.update();	}	private boolean isValidPosTenderTrans(FfSlsPosIntf _ffSlsPosTypeCRec)			throws SQLException {		final String validateCreditCardNoPattern = "^\\S*[^0-9^\\*]\\S*$"; // edited by Laili 2012-10-01 for Aeonmal ticket no:AU-SD003339775		String pymt_type = getPaymentTransType(_ffSlsPosTypeCRec);		String creditCardNo = _ffSlsPosTypeCRec.getString("PI_FIL44");		String merchantCode = _ffSlsPosTypeCRec.getString("PI_MERCHANT_CODE");		String terminalId = _ffSlsPosTypeCRec.getString("PI_TERMINAL_ID");		String approvalCode = _ffSlsPosTypeCRec.getString("PI_APP_CODE");		txtypmstSQL.setTRANS_GRP("C"); // C Tender type		txtypmstSQL.setTRANS_TYPE(pymt_type);		// if (txtypmstSQL.getByKey() == 0)		// {		// slscsherrSQL.setERROR_REMARK("Tender Transaction Type " +		// "'" + pymt_type + "' does not exists");		// return (false);		// }		// start. edited by syukri 17-07-2013 OOM issue		ResultSet rs = null;		PreparedStatement ps = null;		try {			String tquery = " SELECT PAYMENT_TYPE FROM TXTYPMST "					+ " WHERE TRANS_GRP = ? AND TRANS_TYPE = ? ";			if (ps == null) {				ps = conn.prepareStatement(tquery);				ps.setString(1, txtypmstSQL.TRANS_GRP());				ps.setString(2, txtypmstSQL.TRANS_TYPE());				rs = ps.executeQuery();			}			if (rs != null && rs.next()) {				txtypmstSQL.setPAYMENT_TYPE(rs.getString("PAYMENT_TYPE"));			}			else {				slscsherrSQL.setERROR_REMARK("Tender Transaction Type " + "'" + pymt_type + "' does not exists");				return (false);			}		}		finally {			try {				if (rs != null)					rs.close();			} catch (Exception e) {			}			rs = null;			try {				if (ps != null)					ps.close();			} catch (Exception e) {			}			ps = null;		}		// end. edited by syukri 17-07-2013 OOM issue		// Checking for credit card payment type		if (isCreditCardTenderType(txtypmstSQL.PAYMENT_TYPE())) {			// Checks for Merchant Code cannot be blank			if (merchantCode == null || merchantCode.trim().length() == 0) {				slscsherrSQL.setERROR_REMARK("Merchant Code cannot be blank");				return false;			}			// Checks for Terminal ID cannot be blank			if (terminalId == null || terminalId.trim().length() == 0) {				slscsherrSQL.setERROR_REMARK("Terminal ID cannot be blank");				return false;			}			// Checks for Approval Code cannot be blank for all credit card type			// except for KawanKu (KWK) and Easy Payment (ESP)			if (!(txtypmstSQL.TRANS_TYPE().startsWith("KWK"))					&& (approvalCode != null || approvalCode.trim().length() == 0)) {				slscsherrSQL.setERROR_REMARK("Approval Code cannot be blank");			}			// Checks if the Merchant Code exists in MERCHTMST			if (!isValidMerchantCode(merchantCode)) {				slscsherrSQL.setERROR_REMARK("Merchant Code '" + merchantCode + "' does not exists");				return false;			}			if (merchtmstSQL.MERCHT_STORE() != null					&& !merchtmstSQL.MERCHT_STORE().equals(strmstSQL.STORE())) {				slscsherrSQL.setERROR_REMARK("Merchant Code '" + merchantCode						+ "' does not belong to store " + "'" + strmstSQL.STORE() + "'");				return false;			}            //FY - SRAM086047 - 20171114 - Start            // Check Merchant Code must not be flagged Delete            //System.out.println("value for merchtmstSQL.MERCHT_DEL_CD() "+merchtmstSQL.MERCHT_DEL_CD());            if (merchtmstSQL.MERCHT_DEL_CD().equalsIgnoreCase("Y"))            {                slscsherrSQL.setERROR_REMARK("Merchant Code '" + merchantCode						+ "' is flagged Delete '");				return false;            }            //FY - SRAM086047 - 20171114 - End			// Checks Credit Card No. cannot be blank			if (creditCardNo == null || creditCardNo.trim().length() == 0) {				slscsherrSQL.setERROR_REMARK("Credit Card No. cannot be blank");				return false;			}			// Checks Credt Card No. cannot have alpha characters			if (creditCardNo.trim().matches(validateCreditCardNoPattern)) {				slscsherrSQL.setERROR_REMARK("Credit Card No. is not valid");				return false;			}                        // Checks for Merchant Code belong to correct Credit Card No. Added                        // by Laili 2012/04/18 ticket no:AU-SD002722464                        if (!isCorrectMappingMerchantCodeAndCredCardNo(merchantCode,                                        creditCardNo, txtypmstSQL.TRANS_TYPE())) {                                slscsherrSQL.setERROR_REMARK("Merchant Code does not belong " + "to the correct Credit Card No.");                                    return false;                        }                        			// Checks for Credit Card No. Range			if (!isCorrectCreditCardNoRange(creditCardNo,					txtypmstSQL.TRANS_TYPE())) {				slscsherrSQL.setERROR_REMARK("Credit Card No. is not within " + "its range");				return false;			}			// Checks if the Trade Debtor Account Code exists			if (!isTradeDebtorAcctCodeExists(strmstSQL.STORE_COY(),					strmstSQL.STORE(), txtypmstSQL.TRANS_TYPE(),					merchtmstSQL.MERCHT_BANK())) {				slscsherrSQL.setERROR_REMARK("Combination of Bank and Card Type " + "cannot find any trade debtor " + "account code");				return false;			} else {				return true;			}		}		// Checking for Easy Payment Tender Type		else if (isEasyPaymentTenderType(txtypmstSQL.PAYMENT_TYPE())) {			if ((creditCardNo != null && creditCardNo.trim().length() > 0)					|| (merchantCode != null && merchantCode.trim().length() > 0)					|| (terminalId != null && terminalId.trim().length() > 0)					|| (approvalCode != null && approvalCode.trim().length() > 0)) {				slscsherrSQL.setERROR_REMARK("Invalid Easy Payment. Easy Payment "								+ "tender type should not have "								+ "Credit Card No., Merchant Code, "								+ "Terminal ID and Approval Code");				return false;			} else {				return true;			}		} else {			return true;		}	} // isValidPosTenderTrans	private double calcAuthoriseDisc(SlstxdetSQL _slstxdet) throws SQLException {		if (classmstSQL.CLASS().equals(itemmstSQL.CLASS()) == false) {			classmstSQL.setCLASS(itemmstSQL.CLASS());			if (classmstSQL.getByKey() == 0) // syukri AU-IM002352300			{				// logger.warning("Classmst record does not exist. CLASS=" +				// classmstSQL.CLASS());				this.writeln("Classmst record does not exist. CLASS=" + classmstSQL.CLASS());			}		}		if (!sbclsmstSQL.SUBCLASS().equals(itemmstSQL.SUBCLASS())) {			sbclsmstSQL.setSUBCLASS(itemmstSQL.SUBCLASS());			if (sbclsmstSQL.getByKey() == 0) // syukri AU-IM002352300			{				this.writeln("Sbclsmst record does not exist. SUBCLASS=" + sbclsmstSQL.SUBCLASS());			}		}		// 2007-03-28		// if(classmstSQL.CCESS_CSIGN_CLASS().equals("D") == false ||		// classmstSQL.AUTO_PA().equals("Y") == false)		// return 0;		// 2008-02-27		if (classmstSQL.CCESS_CSIGN_CLASS().equals("D") == false				|| sbclsmstSQL.AUTO_PA().equals("Y") == false) {			return 0;		}		if (classmstSQL.COST_CLASS().equals("Y")				|| itemmstSQL.ITEM_WEIGH_CD().equals("Y")) {			// || itemmstSQL.ITEM_NON_INVENTORY_FLAG().equals("Y"))//2007-03-28			// Aeon control price change using AUTO_PA flag			return 0;		}		// Derek 2015-05-22 Tax Relief function AMY		if ((SYSBlockPATaxRelief != null && SYSBlockPATaxRelief.equals("Y"))				&& (SYSTaxReliefTaxCode != null && _slstxdet.SALES_VAT_CODE().equals(SYSTaxReliefTaxCode))) {			return 0;		}// end		double total_disc = _slstxdet.PROMO_DISC() + _slstxdet.STAFF_DISC()				+ _slstxdet.MEMBER_DISC() + _slstxdet.POS_DISC()				+ _slstxdet.OTHER_DISC1() + _slstxdet.OTHER_DISC2()				+ _slstxdet.OTHER_DISC3() + _slstxdet.EXEC_DISC()				+ _slstxdet.CARD_DISC() + _slstxdet.GROUP_DISC()				+ _slstxdet.STDD_DISC() + _slstxdet.MFR_DISC()				+ _slstxdet.MBR_AUTO_DISC() // JoeMy 2015-01-21 GST PCR				+ _slstxdet.RTC_DISC() // Goxz 2017-04-05 POS Member Registration(SRAM041988)-Phase 1				// Goxz 20170810 SRAM071321 PWP - Start				+ _slstxdet.PWP_DISC() + _slstxdet.DISC_1() + _slstxdet.DISC_2()				+ _slstxdet.DISC_3() + _slstxdet.DISC_4() + _slstxdet.DISC_5();				// Goxz 20170810 SRAM071321 PWP - End		double auth_disc = _slstxdet.CURRENT_RETAIL() - (_slstxdet.EXT_NET_SALES() + total_disc);		return auth_disc;	}	private double calcEXT_DISC_AMOUNT(SlstxdetSQL _slstxdet) {		return (_slstxdet.PROMO_DISC() + _slstxdet.STAFF_DISC()				+ _slstxdet.MEMBER_DISC() + _slstxdet.POS_DISC()				+ _slstxdet.OTHER_DISC1() + _slstxdet.OTHER_DISC2()				+ _slstxdet.OTHER_DISC3() + _slstxdet.GROUP_DISC()				+ _slstxdet.AUTHORISE_DISC() + _slstxdet.EXEC_DISC()				+ _slstxdet.CARD_DISC() + _slstxdet.STDD_DISC()				+ _slstxdet.MFR_DISC() + _slstxdet.MBR_AUTO_DISC() // JoeMy 2015-01-21 GST PCR				+ _slstxdet.RTC_DISC()				// Goxz 20170810 SRAM071321 PWP - Start				+ _slstxdet.PWP_DISC() + _slstxdet.DISC_1() + _slstxdet.DISC_2()				+ _slstxdet.DISC_3() + _slstxdet.DISC_4() + _slstxdet.DISC_5()				// Goxz 20170810 SRAM071321 PWP - End				);	}	private void updateSLSTXDET(FfSlsPosIntf _ffSlsPosTypeARec)			throws SQLException, Exception {		int val_sign = 1; // positive = 1 or negative = -1		double d = 0;		slstxdetSQL.setVObject((new SlstxdetInfo()).getVObject()); // clear data		slstxdetSQL.setCOY(strmstSQL.STORE_COY());		slstxdetSQL.setCOY_SUB(strmstSQL.STORE_COY_SUB());		slstxdetSQL.setSTORE(strmstSQL.STORE());		slstxdetSQL.setSALES_TRANS_DATE(pos_sales_trans_date);		slstxdetSQL.setSTORE_POS_NUMBER(ffSlsPosTypeARec.getString("PI_POS"));		slstxdetSQL.setSTORE_POS_TRANS(ffSlsPosTypeARec.getString("PI_TRANS_NO"));		slstxdetSQL.setSALES_SEQ(++item_seq_no);		// already exist		if (slstxhdr_exist == true && slstxdetSQL.checkKeyExist() > 0) {			return;		}		slstxdetSQL.setPOST_TRANS_DATE(posting_date);		slstxdetSQL.setSALES_TRANS_GROUP("S"); // default to "S"		if (ffSlsPosTypeARec.getString("PI_ATYPE").equals("0001")) {			slstxdetSQL.setSALES_TRANS_TYPE(TRNItemSales);			val_sign = 1;		} else if (ffSlsPosTypeARec.getString("PI_ATYPE").equals("0301")) {			slstxdetSQL.setSALES_TRANS_TYPE(TRNItemSalesRet);			// Aeon pos already provide the amount in -ve			// val_sign = -1;		}// WenTem 2015-12-23 breakset start		slstxdetSQL.setBREAKSET_FLAG(PackItemFlag);		double QTY = 0.0;		if (slstxdetSQL.BREAKSET_FLAG().equals("Y")) {			slstxdetSQL.setPOS_SKU(packhdrSQL.PACK_SKU());			slstxdetSQL.setPOS_QTY(ffSlsPosTypeARec.getDouble("PI_QTY"));			slstxdetSQL.setBREAKSET_CONV_RATE(packdetSQL.QTY_PER_SKU());			slstxdetSQL.setINNER_SKU(packdetSQL.SHORT_SKU());			QTY = ffSlsPosTypeARec.getDouble("PI_QTY") * slstxdetSQL.BREAKSET_CONV_RATE();			slstxdetSQL.setINNER_QTY(QTY);		} else {			slstxdetSQL.setPOS_SKU(itemmstSQL.ITEM_TKT_SKU());			slstxdetSQL.setPOS_QTY(ffSlsPosTypeARec.getDouble("PI_QTY"));			slstxdetSQL.setBREAKSET_CONV_RATE(1);			slstxdetSQL.setINNER_SKU(itemmstSQL.ITEM_TKT_SKU());			slstxdetSQL.setINNER_QTY(ffSlsPosTypeARec.getDouble("PI_QTY"));			QTY = slstxdetSQL.POS_QTY();		}		if (PackItemFlag != null && PackItemFlag.equals("Y"))			hdrPackItemFlag = "Y";		// WenTem 2015-12-23 breakset end		slstxdetSQL.setITEM_GROUP(itemmstSQL.CLASS()); // Awkw 2007-03-28		slstxdetSQL.setSHORT_SKU(itemmstSQL.ITEM_TKT_SKU());		slstxdetSQL.setQTY_SOLD(QTY * val_sign);		slstxdetSQL.setSALES_SELL_UNIT(itemmstSQL.ITEM_SELL_UNIT());		if (ffSlsPosTypeARec.getDouble("PI_QTY") == 0) {			slstxdetSQL.setUNIT_SELL(0);		} else {			// new rounding implementation lady			d = ffSlsPosTypeARec.getDouble("PI_ACTUAL_SELL") / QTY;			d = qrRound.roundSell(d);			slstxdetSQL.setUNIT_SELL(d);		}		double unit_price = sellpriceReader.getSellprice(				slstxdetSQL.SALES_TRANS_DATE(), strmstSQL.STORE(),				itemmstSQL.ITEM_TKT_SKU());		selprmstSQL.setSTORE(strmstSQL.STORE());		selprmstSQL.setSHORT_SKU(itemmstSQL.ITEM_TKT_SKU());		if (selprmstSQL.getByKey() == 0) {			SelprmstInfo _selprmstInfo = new SelprmstInfo();			selprmstSQL.setVObject(_selprmstInfo.getVObject());			selprmstSQL.setSTORE(strmstSQL.STORE());			selprmstSQL.setSHORT_SKU(itemmstSQL.ITEM_TKT_SKU());			selprmstSQL.setDefault(strmstSQL.STORE(), itemmstSQL);			selprmstSQL.setLAST_OPR(LAST_OPR);			selprmstSQL.setLAST_OPR_FUNCT(LAST_OPR_FUNCT);			if (itemmstSQL.ITEM_WEIGH_CD().equals("Y") == false) {				selprmstSQL.insert();			}		}		double curr_retail = unit_price * slstxdetSQL.QTY_SOLD();		curr_retail = qrRound.roundSell(curr_retail);// new rounding implementation lady		if (itemmstSQL.ITEM_WEIGH_CD().equals("Y")) {			curr_retail = ffSlsPosTypeARec.getDouble("PI_REG_SELL") * val_sign;		}		slstxdetSQL.setCURRENT_RETAIL(curr_retail);		slstxdetSQL.setEXT_SELL(ffSlsPosTypeARec.getDouble("PI_REG_SELL") * val_sign * slstxdetSQL.POS_QTY());		slstxdetSQL.setDISC_TYPE_CODE(ffSlsPosTypeARec.getString("PI_DISC_TYPE"));		slstxdetSQL.setMEMBER_DISC(ffSlsPosTypeARec.getDouble("PI_DISC2_AMT") * val_sign);		slstxdetSQL.setOTHER_DISC1(ffSlsPosTypeARec.getDouble("PI_DISC3_AMT") * val_sign);		slstxdetSQL.setEXEC_DISC(ffSlsPosTypeARec.getDouble("PI_DISC4_AMT") * val_sign);		slstxdetSQL.setPOS_DISC(ffSlsPosTypeARec.getDouble("PI_DISC5_AMT") * val_sign);		slstxdetSQL.setSTAFF_DISC(ffSlsPosTypeARec.getDouble("PI_DISC6_AMT") * val_sign);		slstxdetSQL.setOTHER_DISC2(ffSlsPosTypeARec.getDouble("PI_DISC7_AMT") * val_sign);		slstxdetSQL.setGROUP_DISC(ffSlsPosTypeARec.getDouble("PI_DISC8_AMT") * val_sign);		slstxdetSQL.setSTDD_DISC(ffSlsPosTypeARec.getDouble("PI_DISC9_AMT") * val_sign);		slstxdetSQL.setPROMO_DISC(ffSlsPosTypeARec.getDouble("PI_DISC10_AMT") * val_sign);		slstxdetSQL.setMFR_DISC(ffSlsPosTypeARec.getDouble("PI_DISC11_AMT") * val_sign);		// Goxz 2017-02-16 AMY PCR – SRAM046010 Mommy Card Implementation - Start		slstxdetSQL.setMBR_AUTO_DISC(ffSlsPosTypeARec.getDouble("PI_DISC12_AMT") * val_sign);		slstxdetSQL.setCARD_DISC(ffSlsPosTypeARec.getDouble("PI_DISC13_AMT") * val_sign);		// Goxz 2017-02-16 AMY PCR – SRAM046010 Mommy Card Implementation - End		// Goxz 2017-04-05 POS Member Registration(SRAM041988)-Phase 1 - Start		slstxdetSQL.setRTC_DISC(ffSlsPosTypeARec.getDouble("PI_DISC14_AMT") * val_sign);		// Goxz 2017-04-05 POS Member Registration(SRAM041988)-Phase 1 - End		// Goxz 20170810 SRAM071321 PWP - Start		slstxdetSQL.setPWP_DISC(ffSlsPosTypeARec.getDouble("PI_DISC15_AMT") * val_sign);		slstxdetSQL.setDISC_1(ffSlsPosTypeARec.getDouble("PI_DISC16_AMT") * val_sign);		slstxdetSQL.setDISC_2(ffSlsPosTypeARec.getDouble("PI_DISC17_AMT") * val_sign);		slstxdetSQL.setDISC_3(ffSlsPosTypeARec.getDouble("PI_DISC18_AMT") * val_sign);		slstxdetSQL.setDISC_4(ffSlsPosTypeARec.getDouble("PI_DISC19_AMT") * val_sign);		slstxdetSQL.setDISC_5(ffSlsPosTypeARec.getDouble("PI_DISC20_AMT") * val_sign);		// Goxz 20170810 SRAM071321 PWP - End		// Keep Discount Type's Price Change No.		slstxdetSQL.setPRCCHG_PROMO_DISC(ffSlsPosTypeARec.getLong("PI_PRCCHG_NO") * val_sign);		slstxdetSQL.setPRCCHG_MIX_MATCH_DISC(ffSlsPosTypeARec.getLong("PI_PRCCHG2_NO") * val_sign);		slstxdetSQL.setPRCCHG_GROUP_DISC(ffSlsPosTypeARec.getLong("PI_PRCCHG3_NO") * val_sign);		slstxdetSQL.setPRCCHG_MEMBER_DISC(ffSlsPosTypeARec.getLong("PI_PRCCHG1_NO") * val_sign);		slstxdetSQL.setEXT_NET_SALES(ffSlsPosTypeARec.getDouble("PI_ACTUAL_SELL") * val_sign);		// JoeMy 2015-01-21 GST PCR - start		if (ffSlsPosTypeARec.getString("PI_TAX_CODE") == null				|| ffSlsPosTypeARec.getString("PI_TAX_CODE").trim().length() == 0) {			// JoeMy 2015-03-02 to control code before GST period			if ((SYSImpAMYSpGST != null && SYSImpAMYSpGST.equals("Y"))					&& (SYSAMYGSTEffDate != null && qrMisc.compareSqlDate(							slstxdetSQL.SALES_TRANS_DATE(), "<",							qrMisc.parseSqlDate(SYSAMYGSTEffDate)))) {				slstxdetSQL.setSALES_VAT_CODE(SYSSellVATBefGST);			} else {				// note: pos should give us the GST_SELL_RATE of the transaction date				slstxdetSQL.setSALES_VAT_CODE(itemmstSQL.ITEM_SELL_VAT_CODE());			}		} else {			slstxdetSQL.setSALES_VAT_CODE(ffSlsPosTypeARec.getString("PI_TAX_CODE"));		}		if (ffSlsPosTypeARec.getString("PI_FILA15") == null				|| ffSlsPosTypeARec.getString("PI_FILA15").trim().length() == 0) {			slstxdetSQL.setSALES_VAT_RATE(itemmstSQL.GST_SELL_RATE());		} else {			slstxdetSQL.setSALES_VAT_RATE(Double.parseDouble(ffSlsPosTypeARec.getString("PI_FILA15")));		}		/*		 * double vat_amt = slstxdetSQL.EXT_NET_SALES() * (1 - 100 / (100 +		 * itemmstSQL.GST_SELL_RATE())); vat_amt =		 * qrRound.roundSell(vat_amt);//new roundind implementation lady		 * slstxdetSQL.setSALES_VAT_AMOUNT(vat_amt);		 */		slstxdetSQL.setSALES_VAT_AMOUNT(ffSlsPosTypeARec.getDouble("PI_GST_AMT"));		// JoeMy 2015-01-21 GST PCR - end		slstxdetSQL.setUPDATE_FLAG(IF_Slstxdet.UPDATE_FLAGoUpload); // the sales data is uploaded from pos system		slstxdetSQL.setUPDATE_STATUS(IF_Slstxdet.UPDATE_STATUSoNo); // this slstxdet record has not been updated into invetory		// calcAuthoriseDisc() needs value of slstxdetSQL.CURRENT_RETAIL and		// all the discounts		slstxdetSQL.setAUTHORISE_DISC(calcAuthoriseDisc(slstxdetSQL));		slstxdetSQL.setEXT_DISC_AMOUNT(calcEXT_DISC_AMOUNT(slstxdetSQL));		slstxdetSQL.setPRIVILLEGE_MEM(ffSlsPosTypeARec.getString("PI_PRVILEGE_MEM"));		slstxdetSQL.setPRICE_OVER_WRITE(ffSlsPosTypeARec.getString("PI_OVER_WRITE"));		// Derek 2015-05-22 Tax Relief function AMY		slstxdetSQL.setORG_GST_RATE(Double.parseDouble(ffSlsPosTypeARec.getString("PI_ORG_GST_RATE")));		slstxdetSQL.setRS_AMT(ffSlsPosTypeARec.getDouble("PI_RS_AMT"));		slstxdetSQL.setORG_GST_CODE(ffSlsPosTypeARec.getString("PI_ORG_GST_CODE"));		// JoeMy 2015-01-21 GST PCR		// double total_disc_wo_tax = slstxdetSQL.EXT_DISC_AMOUNT() * (100 /		// (100 + itemmstSQL.GST_SELL_RATE()));		// double total_disc_wo_tax = slstxdetSQL.EXT_DISC_AMOUNT() / (1 +		// (slstxdetSQL.SALES_VAT_RATE()/100));		double total_disc_wo_tax = 0;		if ((SYSBlockPATaxRelief != null && SYSBlockPATaxRelief.equals("Y"))				&& (SYSTaxReliefTaxCode != null && slstxdetSQL.SALES_VAT_CODE().equals(SYSTaxReliefTaxCode))) {			total_disc_wo_tax = slstxdetSQL.EXT_DISC_AMOUNT() / (1 + (slstxdetSQL.ORG_GST_RATE() / 100));		} else {			total_disc_wo_tax = slstxdetSQL.EXT_DISC_AMOUNT() / (1 + (slstxdetSQL.SALES_VAT_RATE() / 100));		}		total_disc_wo_tax = qrRound.roundDisc(total_disc_wo_tax);// new rounding implementation lady		slstxdetSQL.setEXT_DISC_VAT(slstxdetSQL.EXT_DISC_AMOUNT() - total_disc_wo_tax);		dblPROMO_DISC_TOT += slstxdetSQL.PROMO_DISC();		dblSTAFF_DISC_TOT += slstxdetSQL.STAFF_DISC();		dblAUTHORISE_DISC_TOT += slstxdetSQL.AUTHORISE_DISC();		dblMEMBER_DISC_TOT += slstxdetSQL.MEMBER_DISC();		dblPOS_DISC_TOT += slstxdetSQL.POS_DISC();		dblOTHER_DISC_TOT1 += slstxdetSQL.OTHER_DISC1();		dblOTHER_DISC_TOT2 += slstxdetSQL.OTHER_DISC2();		dblOTHER_DISC_TOT3 += slstxdetSQL.OTHER_DISC3();		dblEXEC_DISC_TOT += slstxdetSQL.EXEC_DISC();		dblCARD_DISC_TOT += slstxdetSQL.CARD_DISC();		dblGROUP_DISC_TOT += slstxdetSQL.GROUP_DISC(); // added by stanley 2009-12-16		dblSTDD_DISC_TOT += slstxdetSQL.STDD_DISC(); // added by stanley 2009-12-16		dblMFR_DISC_TOT += slstxdetSQL.MFR_DISC(); // added by stanley 2009-12-16		dblMBR_AUTO_DISC_TOT += slstxdetSQL.MBR_AUTO_DISC(); // JoeMy 2015-01-22 GST PCR		dblRTC_DISC_TOT += slstxdetSQL.RTC_DISC(); // Goxz 2017-04-05 POS Member Registration(SRAM041988)-Phase 1		dblPWP_DISC_TOT += slstxdetSQL.PWP_DISC(); // Goxz 20170810 SRAM071321 PWP		dblDISC_1_TOT += slstxdetSQL.DISC_1(); // Goxz 20170810 SRAM071321 PWP		dblDISC_2_TOT += slstxdetSQL.DISC_2(); // Goxz 20170810 SRAM071321 PWP		dblDISC_3_TOT += slstxdetSQL.DISC_3(); // Goxz 20170810 SRAM071321 PWP		dblDISC_4_TOT += slstxdetSQL.DISC_4(); // Goxz 20170810 SRAM071321 PWP		dblDISC_5_TOT += slstxdetSQL.DISC_5(); // Goxz 20170810 SRAM071321 PWP		Qty_total += slstxdetSQL.QTY_SOLD();		if (sysSystemUser.isAeonTw()) {			slstxdetSQL.setSTAFF_ID(ffSlsPosTypeARec.getString("PI_STAFF_ID"));		}		slstxdetSQL.setLAST_OPR(LAST_OPR);		slstxdetSQL.setLAST_OPR_FUNCT(LAST_OPR_FUNCT);		// Ryan AU-SD002981732 2012-12-13		if (ffSlsPosTypeARec.getString("PI_CDO_NO").trim().length() > 0) {			if (CDO_REC_TYPE.equals("H")) {				if (slstxhdrSQL.CDO_NO().length() > 0) {					slstxdetSQL.setCDO_NO(slstxhdrSQL.CDO_NO());				} else {					if (updateHDR) {						slstxhdrSQL.setCDO_NO(ffSlsPosTypeARec.getString("PI_CDO_NO").trim());						slstxhdrSQL.update();						updateHDR = false;					}					slstxdetSQL.setCDO_NO(ffSlsPosTypeARec.getString("PI_CDO_NO").trim());				}			} else if (CDO_REC_TYPE.equals("D")) {				slstxdetSQL.setCDO_NO(ffSlsPosTypeARec.getString("PI_CDO_NO").trim());			}		}                                // AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23 - Start                //slstxdetSQL.setCASHIER_NAME(ffSlsPosTypeARec.getString("PI_CASHIER_NAME").trim());                slstxdetSQL.setPOS_AUTHORIZED_ID(ffSlsPosTypeARec.getString("PI_POS_AUTHORIZED_ID").trim());                slstxdetSQL.setPOS_AUTHORIZED_NAME(ffSlsPosTypeARec.getString("PI_POS_AUTHORIZED_NAME").trim());                // AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23 - End		                slstxdetSQL.setSALES_TAX_AMT(ffSlsPosTypeARec.getDouble("PI_SALES_TAX_AMT"));                                updated_typeA_rec++;		slstxdetSQL.insert();	}	private void updateSLSTXERR() throws SQLException, Exception {		int val_sign = 1; // positive = 1 or negative = -1		double d = 0;		slstxerrSQL.setCOY(strmstSQL.STORE_COY());		slstxerrSQL.setCOY_SUB(strmstSQL.STORE_COY_SUB());		slstxerrSQL.setSTORE(strmstSQL.STORE());		slstxerrSQL.setSALES_TRANS_DATE(pos_sales_trans_date);		slstxerrSQL.setSTORE_POS_NUMBER(ffSlsPosTypeARec.getString("PI_POS"));		slstxerrSQL.setSTORE_POS_TRANS(ffSlsPosTypeARec.getString("PI_TRANS_NO"));		slstxerrSQL.setSALES_SEQ(++item_seq_no);		if (slstxerrSQL.checkKeyExist() > 0) // already exist		{			return;		}		slstxerrSQL.setPOST_TRANS_DATE(posting_date);		slstxerrSQL.setSALES_TRANS_GROUP("S"); // default to "S"		if (ffSlsPosTypeARec.getString("PI_ATYPE").equals("0001")) {			slstxerrSQL.setSALES_TRANS_TYPE(TRNItemSales);			val_sign = 1;		} else if (ffSlsPosTypeARec.getString("PI_ATYPE").equals("0301")) {			slstxerrSQL.setSALES_TRANS_TYPE(TRNItemSalesRet);			// Aeon pos already provide the amount in -ve			// val_sign = -1;		}		slstxerrSQL.setSHORT_SKU(ffSlsPosTypeARec.getString("PI_SKU"));		slstxerrSQL.setQTY_SOLD(ffSlsPosTypeARec.getDouble("PI_QTY") * val_sign);		if (ffSlsPosTypeARec.getDouble("PI_QTY") == 0) {			slstxerrSQL.setUNIT_SELL(0);		} else {			// new rounding implementation lady			d = ffSlsPosTypeARec.getDouble("PI_ACTUAL_SELL") / ffSlsPosTypeARec.getDouble("PI_QTY");			d = qrRound.roundSell(d);			slstxerrSQL.setUNIT_SELL(d);		}		slstxerrSQL.setSALES_SELL_UNIT(itemmstSQL.ITEM_SELL_UNIT());		slstxerrSQL.setEXT_SELL(ffSlsPosTypeARec.getDouble("PI_REG_SELL") * val_sign * slstxerrSQL.QTY_SOLD());		slstxerrSQL.setDISC_TYPE_CODE(null);		slstxerrSQL.setMEMBER_DISC(ffSlsPosTypeARec.getDouble("PI_DISC2_AMT") * val_sign);		slstxerrSQL.setOTHER_DISC1(ffSlsPosTypeARec.getDouble("PI_DISC3_AMT") * val_sign);		slstxerrSQL.setEXEC_DISC(ffSlsPosTypeARec.getDouble("PI_DISC4_AMT") * val_sign);		slstxerrSQL.setPOS_DISC(ffSlsPosTypeARec.getDouble("PI_DISC5_AMT") * val_sign);		slstxerrSQL.setSTAFF_DISC(ffSlsPosTypeARec.getDouble("PI_DISC6_AMT") * val_sign);		slstxerrSQL.setOTHER_DISC2(ffSlsPosTypeARec.getDouble("PI_DISC7_AMT") * val_sign);		slstxerrSQL.setGROUP_DISC(ffSlsPosTypeARec.getDouble("PI_DISC8_AMT") * val_sign);		slstxerrSQL.setSTDD_DISC(ffSlsPosTypeARec.getDouble("PI_DISC9_AMT") * val_sign);		slstxerrSQL.setPROMO_DISC(ffSlsPosTypeARec.getDouble("PI_DISC10_AMT") * val_sign);		slstxerrSQL.setMFR_DISC(ffSlsPosTypeARec.getDouble("PI_DISC11_AMT") * val_sign);		// Goxz 2017-02-16 AMY PCR – SRAM046010 Mommy Card Implementation - Start		slstxerrSQL.setMBR_AUTO_DISC(ffSlsPosTypeARec.getDouble("PI_DISC12_AMT") * val_sign);		slstxerrSQL.setCARD_DISC(ffSlsPosTypeARec.getDouble("PI_DISC13_AMT") * val_sign);		// Goxz 2017-02-16 AMY PCR – SRAM046010 Mommy Card Implementation - End		// Added by kofam 2017-05-18 Keep Discount Type Price Change No.		slstxerrSQL.setPRCCHG_PROMO_DISC(ffSlsPosTypeARec.getLong("PI_PRCCHG_NO") * val_sign);		slstxerrSQL.setPRCCHG_MIX_MATCH_DISC(ffSlsPosTypeARec.getLong("PI_PRCCHG2_NO") * val_sign);		slstxerrSQL.setPRCCHG_GROUP_DISC(ffSlsPosTypeARec.getLong("PI_PRCCHG3_NO") * val_sign);		slstxerrSQL.setPRCCHG_MEMBER_DISC(ffSlsPosTypeARec.getLong("PI_PRCCHG1_NO") * val_sign);		// End added by kofam 2017-05-18		// Goxz 2017-04-05 POS Member Registration(SRAM041988)-Phase 1 - Start		slstxerrSQL.setRTC_DISC(ffSlsPosTypeARec.getDouble("PI_DISC14_AMT") * val_sign);		// Goxz 2017-04-05 POS Member Registration(SRAM041988)-Phase 1 - End		// Goxz 20170810 SRAM071321 PWP - Start		slstxerrSQL.setPWP_DISC(ffSlsPosTypeARec.getDouble("PI_DISC15_AMT") * val_sign);		slstxerrSQL.setDISC_1(ffSlsPosTypeARec.getDouble("PI_DISC16_AMT") * val_sign);		slstxerrSQL.setDISC_2(ffSlsPosTypeARec.getDouble("PI_DISC17_AMT") * val_sign);		slstxerrSQL.setDISC_3(ffSlsPosTypeARec.getDouble("PI_DISC18_AMT") * val_sign);		slstxerrSQL.setDISC_4(ffSlsPosTypeARec.getDouble("PI_DISC19_AMT") * val_sign);		slstxerrSQL.setDISC_5(ffSlsPosTypeARec.getDouble("PI_DISC20_AMT") * val_sign);		// Goxz 20170810 SRAM071321 PWP - End		slstxerrSQL.setEXT_NET_SALES(ffSlsPosTypeARec.getDouble("PI_ACTUAL_SELL") * val_sign);		// JoeMy 2015-01-16 GST PCR - start		if (ffSlsPosTypeARec.getString("PI_TAX_CODE") == null				|| ffSlsPosTypeARec.getString("PI_TAX_CODE").length() == 0) {			// JoeMy 2015-03-02 to control code before GST period			if ((SYSImpAMYSpGST != null && SYSImpAMYSpGST.equals("Y"))					&& (SYSAMYGSTEffDate != null && qrMisc.compareSqlDate(							slstxerrSQL.SALES_TRANS_DATE(), "<",							qrMisc.parseSqlDate(SYSAMYGSTEffDate)))) {				slstxerrSQL.setSALES_VAT_CODE(SYSSellVATBefGST);			} else {				// note: pos should give us the GST_SELL_RATE of the transaction date				slstxerrSQL.setSALES_VAT_CODE(itemmstSQL.ITEM_SELL_VAT_CODE());			}		} else {			slstxerrSQL.setSALES_VAT_CODE(ffSlsPosTypeARec.getString("PI_TAX_CODE").trim());		}		if (ffSlsPosTypeARec.getString("PI_FILA15") == null				|| ffSlsPosTypeARec.getString("PI_FILA15").length() == 0) {			// note: pos should give us the GST_SELL_RATE of the transaction date			slstxerrSQL.setSALES_VAT_RATE(itemmstSQL.GST_SELL_RATE());		} else {			slstxerrSQL.setSALES_VAT_RATE(Double.parseDouble(ffSlsPosTypeARec.getString("PI_FILA15")));		}		/*		 * double vat_amt = slstxerrSQL.EXT_NET_SALES() * (1 - 100 / (100 +		 * itemmstSQL.GST_SELL_RATE())); vat_amt =		 * qrRound.roundSell(vat_amt);//new rounding implementation lady		 * slstxerrSQL.setSALES_VAT_AMOUNT(vat_amt);		 */		slstxerrSQL.setSALES_VAT_AMOUNT(ffSlsPosTypeARec.getDouble("PI_GST_AMT"));		// JoeMy 2015-01-16 GST PCR - end		slstxerrSQL.setUPDATE_FLAG(IF_Slstxdet.UPDATE_FLAGoUpload); // the sales data is uploaded from pos system		slstxerrSQL.setUPDATE_STATUS(IF_Slstxdet.UPDATE_STATUSoNo); // this slstxdet record has not been updated into invetory		StringBuffer strbuf = new StringBuffer();		for (int i = 0; i < err_msg.size(); i++) {			strbuf.append(i + 1).append("=").append((String) err_msg.get(i));			strbuf.append("  ");		}		slstxerrSQL.setERROR_REMARK(strbuf.toString());		dblPROMO_DISC_TOT += slstxerrSQL.PROMO_DISC();		dblSTAFF_DISC_TOT += slstxerrSQL.STAFF_DISC();		dblMEMBER_DISC_TOT += slstxerrSQL.MEMBER_DISC();		dblPOS_DISC_TOT += slstxerrSQL.POS_DISC();		dblOTHER_DISC_TOT1 += slstxerrSQL.OTHER_DISC1();		dblOTHER_DISC_TOT2 += slstxerrSQL.OTHER_DISC2();		dblOTHER_DISC_TOT3 += slstxerrSQL.OTHER_DISC3();		dblEXEC_DISC_TOT += slstxerrSQL.EXEC_DISC();		dblCARD_DISC_TOT += slstxerrSQL.CARD_DISC();		dblGROUP_DISC_TOT += slstxerrSQL.GROUP_DISC(); // added by stanley 2009-12-16		dblSTDD_DISC_TOT += slstxerrSQL.STDD_DISC(); // added by stanley 2009-12-16		dblMFR_DISC_TOT += slstxerrSQL.MFR_DISC(); // added by stanley 2009-12-16		dblMBR_AUTO_DISC_TOT += slstxerrSQL.MBR_AUTO_DISC(); // JoeMy 2015-01-21 GST PCR		dblRTC_DISC_TOT += slstxerrSQL.RTC_DISC(); // Goxz 2017-04-05 POS Member Registration(SRAM041988)-Phase 1		dblPWP_DISC_TOT += slstxerrSQL.PWP_DISC(); // Goxz 20170810 SRAM071321 PWP		dblDISC_1_TOT += slstxerrSQL.DISC_1(); // Goxz 20170810 SRAM071321 PWP		dblDISC_2_TOT += slstxerrSQL.DISC_2(); // Goxz 20170810 SRAM071321 PWP		dblDISC_3_TOT += slstxerrSQL.DISC_3(); // Goxz 20170810 SRAM071321 PWP		dblDISC_4_TOT += slstxerrSQL.DISC_4(); // Goxz 20170810 SRAM071321 PWP		dblDISC_5_TOT += slstxerrSQL.DISC_5(); // Goxz 20170810 SRAM071321 PWP		Qty_total += slstxerrSQL.QTY_SOLD();		if (sysSystemUser.isAeonTw()) {			slstxerrSQL.setSTAFF_ID(ffSlsPosTypeARec.getString("PI_STAFF_ID"));		}		slstxerrSQL.setLAST_OPR(LAST_OPR);		slstxerrSQL.setLAST_OPR_FUNCT(LAST_OPR_FUNCT);		// Ryan AU-SD002981732 2012-12-13		if (ffSlsPosTypeARec.getString("PI_CDO_NO").trim().length() > 0) {			if (CDO_REC_TYPE.equals("H")) {				if (slstxhdrSQL.CDO_NO().length() > 0) {					slstxerrSQL.setCDO_NO(slstxhdrSQL.CDO_NO());				} else {					if (updateHDR) {						slstxhdrSQL.setCDO_NO(ffSlsPosTypeARec.getString("PI_CDO_NO").trim());						slstxhdrSQL.update();						updateHDR = false;					}					slstxerrSQL.setCDO_NO(ffSlsPosTypeARec.getString("PI_CDO_NO").trim());				}			} else if (CDO_REC_TYPE.equals("D")) {				slstxerrSQL.setCDO_NO(ffSlsPosTypeARec.getString("PI_CDO_NO").trim());			}			slstxerrSQL.setCDO_ERROR("Y");		} else {			slstxerrSQL.setCDO_NO(ffSlsPosTypeARec.getString("PI_CDO_NO").trim());			slstxerrSQL.setCDO_ERROR("N");		}		// Derek 2015-05-22 Tax Relief function AMY		slstxerrSQL.setORG_GST_RATE(Double.parseDouble(ffSlsPosTypeARec.getString("PI_ORG_GST_RATE")));		slstxerrSQL.setRS_AMT(ffSlsPosTypeARec.getDouble("PI_RS_AMT"));		slstxerrSQL.setORG_GST_CODE(ffSlsPosTypeARec.getString("PI_ORG_GST_CODE"));                // AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23 - Start                //slstxerrSQL.setCASHIER_NAME(ffSlsPosTypeARec.getString("PI_CASHIER_NAME").trim());                slstxerrSQL.setPOS_AUTHORIZED_ID(ffSlsPosTypeARec.getString("PI_POS_AUTHORIZED_ID").trim());                slstxerrSQL.setPOS_AUTHORIZED_NAME(ffSlsPosTypeARec.getString("PI_POS_AUTHORIZED_NAME").trim());                // AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23 - End                                slstxerrSQL.setSALES_TAX_AMT(ffSlsPosTypeARec.getDouble("PI_SALES_TAX_AMT"));                		slstxerrSQL.insert();	}	// edited by syukri 17-07-2013 OOM issue	private boolean isValidSku(String sku) throws SQLException {		/**		 * The SKU is passed in 13 characters with zeros ('0') appended in		 * front. Before checking if the SKU exists in ITEMMST, trim all zeros		 * in front and then append zeros in front based on the "SYSSkuMax" from		 * PROFITVV.		 */		ResultSet rs = null;		PreparedStatement ps = null;		boolean flag = true;		try {			itemmstSQL.setSHORT_SKU(qrMisc.leftFillZero(qrMisc.trimFrontZero(sku), Integer.valueOf(SYSSkuMax).intValue()));			String squery = " SELECT CLASS, SUBCLASS, ITEM_WEIGH_CD, ITEM_TKT_SKU, "					+ " ITEM_SELL_UNIT, ITEM_SELL_VAT_CODE, GST_SELL_RATE, "					+ " GST_SELL, GST_SELL_MEMBER,ITEM_PACK " + // JoeMy 2015-01-16 enhancement mapped with selprmst.setDefault					" FROM ITEMMST " + " WHERE SHORT_SKU = ? ";			if (ps == null) {				ps = conn.prepareStatement(squery);				ps.setString(1, itemmstSQL.SHORT_SKU());				rs = ps.executeQuery();			}			if (rs != null && rs.next()) {				itemmstSQL.setCLASS(rs.getString("CLASS"));				itemmstSQL.setSUBCLASS(rs.getString("SUBCLASS"));				itemmstSQL.setITEM_WEIGH_CD(rs.getString("ITEM_WEIGH_CD"));				itemmstSQL.setITEM_TKT_SKU(rs.getString("ITEM_TKT_SKU"));				itemmstSQL.setITEM_SELL_UNIT(rs.getString("ITEM_SELL_UNIT"));				itemmstSQL.setITEM_SELL_VAT_CODE(rs.getString("ITEM_SELL_VAT_CODE"));				itemmstSQL.setGST_SELL_RATE(rs.getDouble("GST_SELL_RATE"));				itemmstSQL.setGST_SELL(rs.getDouble("GST_SELL"));				itemmstSQL.setGST_SELL_MEMBER(rs.getDouble("GST_SELL_MEMBER"));				itemmstSQL.setITEM_PACK(rs.getString("ITEM_PACK"));				flag = true;			}			else {				// clear the previous data if cannot found				itemmstSQL.setVObject(new ItemmstInfo().getVObject());				flag = false;			}		}		finally {			try {				if (rs != null)					rs.close();			} catch (Exception e) {			}			rs = null;			try {				if (ps != null)					ps.close();			} catch (Exception e) {			}			ps = null;		}		return flag;	}// isValidSku	// WenTem 2015-12-23 breakset start	private boolean isValidInnerSku(String sku) throws SQLException {		/**		 * The SKU is passed in 13 characters with zeros ('0') appended in		 * front. Before checking if the SKU exists in ITEMMST, trim all zeros		 * in front and then append zeros in front based on the "SYSSkuMax" from		 * PROFITVV.		 */		ResultSet rs = null;		PreparedStatement ps = null;		boolean flag = true;		try {			innerItemmstSQL.setSHORT_SKU(qrMisc.leftFillZero(qrMisc.trimFrontZero(sku), Integer.valueOf(SYSSkuMax).intValue()));			String squery = " SELECT CLASS, SUBCLASS, ITEM_WEIGH_CD, ITEM_TKT_SKU, "					+ " ITEM_SELL_UNIT, ITEM_SELL_VAT_CODE, GST_SELL_RATE, "					+ " GST_SELL, GST_SELL_MEMBER,ITEM_PACK " + // JoeMy 2015-01-16 enhancement mapped with selprmst.setDefault					" FROM ITEMMST " + " WHERE SHORT_SKU = ? ";			if (ps == null) {				ps = conn.prepareStatement(squery);				ps.setString(1, innerItemmstSQL.SHORT_SKU());				rs = ps.executeQuery();			}			if (rs != null && rs.next()) {				innerItemmstSQL.setCLASS(rs.getString("CLASS"));				innerItemmstSQL.setSUBCLASS(rs.getString("SUBCLASS"));				innerItemmstSQL.setITEM_WEIGH_CD(rs.getString("ITEM_WEIGH_CD"));				innerItemmstSQL.setITEM_TKT_SKU(rs.getString("ITEM_TKT_SKU"));				innerItemmstSQL.setITEM_SELL_UNIT(rs.getString("ITEM_SELL_UNIT"));				innerItemmstSQL.setITEM_SELL_VAT_CODE(rs.getString("ITEM_SELL_VAT_CODE"));				innerItemmstSQL.setGST_SELL_RATE(rs.getDouble("GST_SELL_RATE"));				innerItemmstSQL.setGST_SELL(rs.getDouble("GST_SELL"));				innerItemmstSQL.setGST_SELL_MEMBER(rs.getDouble("GST_SELL_MEMBER"));				innerItemmstSQL.setITEM_PACK(rs.getString("ITEM_PACK"));				flag = true;			}			else {				// clear the previous data if cannot found				innerItemmstSQL.setVObject(new ItemmstInfo().getVObject());				flag = false;			}		}		finally {			try {				if (rs != null)					rs.close();			} catch (Exception e) {			}			rs = null;			try {				if (ps != null)					ps.close();			} catch (Exception e) {			}			ps = null;		}		return flag;	}	private boolean isPackItem(String sku) throws Exception {		boolean flag = true;		ResultSet rs = null;		PreparedStatement ps = null;		try {			String squery = " SELECT * FROM PACKHDR WHERE STORE IN (select VNM_VDTVL from profitvv where COY=? AND VNM = 'SYSHeadOfficeStore') AND PACK_SKU = ? AND PACK_TYPE = 'E' AND PACK_DEL_CD = 'N' ";			ps = conn.prepareStatement(squery);			ps.setString(1, strmstSQL.STORE_COY());			ps.setString(2, sku);			rs = ps.executeQuery();			if (rs != null && rs.next()) {				packhdrSQL.populate(rs);				flag = true;			}			else {				// clear the previous data if cannot found				packhdrSQL.setVObject(new PackhdrInfo().getVObject());				flag = false;			}		} catch (Exception e) {			e.printStackTrace();			System.out.println(e.getMessage());			throw (e);		} finally {			try {				if (rs != null)					rs.close();			} catch (Exception e) {			}			rs = null;			try {				if (ps != null)					ps.close();			} catch (Exception e) {			}			ps = null;		}		return flag;	}	private boolean getPackInnerItem(String sku) throws Exception {		boolean flag = true;		ResultSet rs = null;		PreparedStatement ps = null;		try {			String squery = " SELECT * FROM PACKDET WHERE STORE IN (select VNM_VDTVL from profitvv where COY=? AND VNM = 'SYSHeadOfficeStore') AND PACK_SKU = ?";			ps = conn.prepareStatement(squery);			ps.setString(1, strmstSQL.STORE_COY());			ps.setString(2, sku);			rs = ps.executeQuery();			if (rs != null && rs.next()) {				packdetSQL.populate(rs);				flag = true;			}			else {				// clear the previous data if cannot found				packdetSQL.setVObject(new PackdetInfo().getVObject());				flag = false;			}		} catch (Exception e) {			e.printStackTrace();			System.out.println(e.getMessage());			throw (e);		} finally {			try {				if (rs != null)					rs.close();			} catch (Exception e) {			}			rs = null;			try {				if (ps != null)					ps.close();			} catch (Exception e) {			}			ps = null;		}		return flag;	}	private boolean isVoucherTenderType(String payment_type) {		// wentem 2016-01-07 - New Voucher Transaction Type (0, 9)		return (payment_type != null &&		/*		 * (payment_type.equals(VOUCHER_PAYMENT_TYPE) ||		 * payment_type.equals(PROMOTION_VOUCHER_PAYMENT_TYPE) ||		 * payment_type.equals(REDEMPTION_VOUCHER_PAYMENT_TYPE) ||		 * payment_type.equals(PROMOTION_E_VOUCHER_PAYMENT_TYPE) ||		 * payment_type.equals(PRODUCT_E_VOUCHER_PAYMENT_TYPE) ||		 * payment_type.equals(RECHARGE_ISSUED_E_VOUCHHER_PAYMENT_TYPE)		 */		arrVoucherPaymentType.contains(payment_type)) // JoeMy 2016-11-28 E-Voucher		? true : false;	}	// WenTem 2015-12-23 breakset end        private boolean isCorrectMappingMerchantCodeAndCredCardNo(                    String merchant_code, String credit_card_no,                    String credit_card_trans_type) throws SQLException {            final String QUERY_CREDIT_CARD = "SELECT * "                            + "FROM XCRECDMST X "                            + "WHERE EXISTS ("                            + "SELECT 1 "                            + "FROM XMERCHTMST M "                            + "WHERE M.MERCHT_CREDIT_CARD = X.CREDIT_CARD_CODE AND "                            + "M.MERCHT_CODE = ? "                            + ") AND "                            + "Length (?) BETWEEN LENGTH(FROM_CRECD_NO) AND LENGTH(TO_CRECD_NO) "                            + "AND REPLACE(?, '*', '9') BETWEEN FROM_CRECD_NO AND TO_CRECD_NO ";            try {                pstmt = conn.prepareStatement(QUERY_CREDIT_CARD);                pstmt.setString(1, merchant_code);                pstmt.setString(2, credit_card_no);                pstmt.setString(3, credit_card_no);                rs = pstmt.executeQuery();                if (rs != null && rs.next()) {                        xcrecdmstSQL.setVObject((Vector) new XCrecdmstInfo().getVObject());                        xcrecdmstSQL.populate(rs);                        return true;                } else {                        return (isEMoneyCardVSATrans(credit_card_trans_type,                                        credit_card_no)) ? true : false;                }            } finally {                try {                        if (rs != null) {                                rs.close();                                rs = null;                        }                } catch (SQLException e) {                }                try {                        if (pstmt != null) {                                pstmt.close();                                pstmt = null;                        }                } catch (SQLException e) {                }            }        } // isCorrectMappingMerchantCodeAndCredCardNo	private boolean isCorrectCreditCardNoRange(String credit_card_no,			String credit_card_trans_type) throws SQLException {		final String QUERY_CREDIT_CARD = "SELECT * "				+ "FROM XCRECDMST X "				+ "WHERE EXISTS ("				+ "SELECT 1 "				+ "FROM CRECDMST C "				+ "WHERE C.CREDIT_CARD_CODE = X.CREDIT_CARD_CODE AND "				+ "C.CREDIT_CARD_DEL_CD = 'N' AND "				+ "C.TRANS_TYPE = ? "				+ ") AND "				+				// "? BETWEEN FROM_CRECD_NO AND TO_CRECD_NO"; edited by Laili				// 20/01/2012 for ticket number 200-01-6338348				"Length (?) BETWEEN LENGTH(FROM_CRECD_NO) AND LENGTH(TO_CRECD_NO) "				+ "AND REPLACE(?, '*', '9') BETWEEN FROM_CRECD_NO AND TO_CRECD_NO ";		try {			pstmt = conn.prepareStatement(QUERY_CREDIT_CARD);			pstmt.setString(1, credit_card_trans_type.substring(0, 3));			pstmt.setString(2, credit_card_no);			pstmt.setString(3, credit_card_no);			rs = pstmt.executeQuery();			if (rs != null && rs.next()) {				xcrecdmstSQL.setVObject((Vector) new XCrecdmstInfo().getVObject());				xcrecdmstSQL.populate(rs);				return true;			} else {				return (isKawanKuDebitCard(credit_card_trans_type) || isEMoneyCardVSATrans(						credit_card_trans_type, credit_card_no)) ? true : false;			}		} finally {			try {				if (rs != null) {					rs.close();					rs = null;				}			} catch (SQLException e) {			}			try {				if (pstmt != null) {					pstmt.close();					pstmt = null;				}			} catch (SQLException e) {			}		}	} // isCorrectCreditCardNoRange	private boolean isValidMerchantCode(String merchant_code)			throws SQLException {		if (merchant_code != null && merchant_code.trim().length() > 0) {			merchtmstSQL.setMERCHT_CODE(merchant_code);			return (merchtmstSQL.getByKey() == 0) ? false : true;		} else {			return false;		}	} // isValidMerchantCode	private boolean isCreditCardTenderType(String payment_type) {		return (payment_type != null && payment_type.equals(CREDIT_CARD_PAYMENT_TYPE)) ? true : false;	} // isCreditCardTenderType	private boolean isEasyPaymentTenderType(String payment_type) {		return (payment_type != null && payment_type.equals(EASY_PAYMENT_PAYMENT_TYPE)) ? true : false;	} // isEasyPaymentTenderType	private boolean isKawanKuDebitCard(String trans_type) {		return (trans_type != null && trans_type.startsWith("KWK")) ? true : false;	} // isKawanKuDebitCard	private boolean isEMoneyCardVSATrans(String trans_type,			String credit_card_no) {		return (trans_type != null && trans_type.startsWith("VSA")				&& credit_card_no.trim().length() == 16 && credit_card_no.startsWith("410709")) ? true : false;	} // isEMoneyCard	private boolean isTradeDebtorAcctCodeExists(String coy, String store,			String trans_type, String bank) throws SQLException {		String creditAccount = null;		String creditCardCode = (merchtmstSQL.MERCHT_ZERO_INT_FLAG() != null && merchtmstSQL.MERCHT_ZERO_INT_FLAG().equals("Y")) ? "ZERO" : xcrecdmstSQL.CREDIT_CARD_CODE();		String debitAccount = null;		String creditCardNo = ffSlsPosTypeCRec.getString("PI_FIL44");		creditCardCode = xcrecdmstSQL.CREDIT_CARD_CODE();		if (isKawanKuDebitCard(trans_type)) {			creditCardCode = "7";		}		if (creditCardNo != null && creditCardNo.trim().length() == 16				&& creditCardNo.trim().startsWith("428332")) {			if (trans_type != null && trans_type.startsWith("VSA")) {				creditCardCode = "1";			} else {				creditCardCode = "7";			}		} else {			if (merchtmstSQL.MERCHT_ZERO_INT_FLAG() != null					&& merchtmstSQL.MERCHT_ZERO_INT_FLAG().equals("Y")) {				creditCardCode = "ZERO";			}		}		// JoeMy 2016-12-15 E-Money PCR		if (isEMoneyCardVSATrans(trans_type, creditCardNo)) {			creditCardCode = "1";		}		acctInterface.setAcctInterface("C", trans_type, coy, store, bank,				creditCardCode, // no ap control				"null", // sales type				"null", "null", "null");		creditAccount = acctInterface.getCreditChartOfAccountCode();		debitAccount = acctInterface.getDebitChartOfAccountCode();		if ((creditAccount == null || creditAccount.trim().length() == 0)				&& (debitAccount == null || debitAccount.trim().length() == 0)) {			return false;		} else {			return true;		}	} // isTradeDebtorAcctCodeExists	/**	 * flag = '01' - barcode, '02' - short sku	 * 	 * @param item_code	 * @param flag	 * @return	 * @throws java.sql.SQLException	 */	private boolean isValidItemCode(String item_code, String flag,			String store_category) throws SQLException {		if (flag.equals("02")) // short sku		{			return (isValidSku(item_code));		} else if (flag.equals("01")) // barcode		{			item_code = qrMisc.trimFrontZero(item_code);			xbarcodeSQL.setBARCODE(item_code);			xbarcodeSQL.setSTORE_CATEGORY(store_category);			if (xbarcodeSQL.getByKey() == 0) {				return (false);			}			return (isValidSku(xbarcodeSQL.SHORT_SKU()));		}		return (false);	}	private String profitvv_getByPrimaryKey(String coy, String vnm)			throws SQLException {		profitvvSQL.setCOY(coy);		profitvvSQL.setVNM(vnm);		profitvvSQL.getByKey();		return (profitvvSQL.VNM_VDTVL());	}	/**	 * create an empty Slstxhdr due to the java.sql.SQLException: ORA-02291:	 * integrity constraint (PROFIT.SYS_C003700) violated - parent key not found	 * when inserting record Slstxdet or Slstxerr	 */	private void createSLSTXHDR_empty_record(FfSlsPosIntf _ffSlsPosHdrRec)			throws SQLException {		if (_ffSlsPosHdrRec.getString("PI_FORMAT").equals("A") == false				&& _ffSlsPosHdrRec.getString("PI_FORMAT").equals("B") == false				&& _ffSlsPosHdrRec.getString("PI_FORMAT").equals("C") == false				&& _ffSlsPosHdrRec.getString("PI_FORMAT").equals("D") == false				&& _ffSlsPosHdrRec.getString("PI_FORMAT").equals("G") == false // Goxz 20170803 Pre-Booking				&& _ffSlsPosHdrRec.getString("PI_FORMAT").equals("Z") == false) {			// System.out.println("-----------" + _ffSlsPosHdrRec.toXML());			return; // do not insert		}		slstxhdrSQL.setVObject((new SlstxhdrInfo()).getVObject());		slstxhdrSQL.setCOY(strmstSQL.STORE_COY());		slstxhdrSQL.setCOY_SUB(strmstSQL.STORE_COY_SUB());		slstxhdrSQL.setSTORE(strmstSQL.STORE());		slstxhdrSQL.setPOST_TRANS_DATE(posting_date);		slstxhdrSQL.setSALES_TRANS_DATE(pos_sales_trans_date);		slstxhdrSQL.setSTORE_POS_NUMBER(_ffSlsPosHdrRec.getString("PI_POS"));		slstxhdrSQL.setSTORE_POS_TRANS(_ffSlsPosHdrRec.getString("PI_TRANS_NO"));		slstxhdrSQL.setSALES_CAPTURE_METHOD(IF_Slstxhdr.SALES_CAPTURE_METHODoUpload);		slstxhdrSQL.setSALES_UPDATE_STATUS(IF_Slstxhdr.SALES_UPDATE_STATUSoNo);		slstxhdrSQL.setLAST_OPR_FUNCT("EMPTY");		slstxhdrSQL.setLAST_OPR(LAST_OPR);		slstxhdrSQL.setBREAKSET_FLAG("N");		// JoeMy 2015-01-21 GST PCR		if (_ffSlsPosHdrRec.getString("PI_COMMAND") != null				&& _ffSlsPosHdrRec.getString("PI_COMMAND").trim().equals("0043")) {			slstxhdrSQL.setTRANS_TYPE("SALES");		} else if (_ffSlsPosHdrRec.getString("PI_COMMAND") != null				&& _ffSlsPosHdrRec.getString("PI_COMMAND").trim().equals("0000")) {			slstxhdrSQL.setTRANS_TYPE("TOTAL");		} else if (_ffSlsPosHdrRec.getString("PI_COMMAND") != null				&& _ffSlsPosHdrRec.getString("PI_COMMAND").trim().equals("0044")) {			slstxhdrSQL.setTRANS_TYPE("REFUND");		} else if (_ffSlsPosHdrRec.getString("PI_COMMAND") != null				&& _ffSlsPosHdrRec.getString("PI_COMMAND").trim().equals("0045")) {			slstxhdrSQL.setTRANS_TYPE("VOID");		} else {			slstxhdrSQL.setTRANS_TYPE("");		}		slstxhdrSQL.setSALES_FLAG(_ffSlsPosHdrRec.getString("PI_PRE_BOOK_FLAG")); // Goxz 20170803 Pre-Booking		if (slstxhdrSQL.checkKeyExist() == 0) {			slstxhdrSQL.insert();			slstxhdr_exist = false;		} else {			slstxhdr_exist = true;		}		prebookhdrSQL.setVObject((new PrebookhdrInfo()).getVObject()); // Goxz 20170809 Pre-Booking clear data	}	private void updateSLSTXHDR(FfSlsPosIntf _ffSlsPosTypeBRec)			throws SQLException {		slstxhdrSQL.setCOY(strmstSQL.STORE_COY());		slstxhdrSQL.setCOY_SUB(strmstSQL.STORE_COY_SUB());		slstxhdrSQL.setSTORE(strmstSQL.STORE());		slstxhdrSQL.setSALES_TRANS_DATE(pos_sales_trans_date);		slstxhdrSQL.setSTORE_POS_NUMBER(_ffSlsPosTypeBRec.getString("PI_POS"));		slstxhdrSQL.setSTORE_POS_TRANS(_ffSlsPosTypeBRec.getString("PI_TRANS_NO"));		int rt = slstxhdrSQL.getByKey();		if (rt > 0) // record exist		{			if (slstxhdrSQL.LAST_OPR_FUNCT().equals("EMPTY")) // it is an empty record			{				slstxhdrSQL.setLAST_OPR_FUNCT(LAST_OPR_FUNCT);			} else {				return;			}		}		int val_sign = 1;		if (_ffSlsPosTypeBRec.getString("PI_BTYPE").equals("0011")) {			slstxdetSQL.setSALES_TRANS_TYPE(TRNItemSales);			val_sign = 1;		} else if (_ffSlsPosTypeBRec.getString("PI_BTYPE").equals("0311")) {			slstxdetSQL.setSALES_TRANS_TYPE(TRNItemSalesRet);			// Aeon pos already provide the amount in -ve			// val_sign = -1;		}		slstxhdrSQL.setPOST_TRANS_DATE(posting_date);		// get from record type A Aeon China 2006-05-24 awkw		slstxhdrSQL.setSTAFF_CODE(ffSlsPosTypeARec.getString("PI_EMP_PURCH")); // added by stanley 2009-12-16		slstxhdrSQL.setCASHIER_ID(ffSlsPosTypeARec.getString("PI_CASHIER_ID"));                slstxhdrSQL.setCASHIER_NAME(ffSlsPosTypeARec.getString("PI_CASHIER_NAME")); // added by AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23		slstxhdrSQL.setMEMBER_CODE(_ffSlsPosTypeBRec.getString("PI_MEM_CARD").trim());// added by stanley 2009-12-16		slstxhdrSQL.setSTDD_CODE(_ffSlsPosTypeBRec.getString("PI_KADS1M_CARD").trim()); // Atiqah add for KADS1M 2013-02-04		slstxhdrSQL.setEXT_NET_SELL_TOT(_ffSlsPosTypeBRec.getDouble("PI_TOT_AMT") * val_sign);		slstxhdrSQL.setEXT_QTY_TOT(Qty_total * val_sign);		slstxhdrSQL.setPROMO_DISC_TOT(dblPROMO_DISC_TOT * val_sign);		slstxhdrSQL.setSTAFF_DISC_TOT(dblSTAFF_DISC_TOT * val_sign);		slstxhdrSQL.setAUTHORISE_DISC_TOT(dblAUTHORISE_DISC_TOT * val_sign);		slstxhdrSQL.setMEMBER_DISC_TOT(dblMEMBER_DISC_TOT * val_sign);		slstxhdrSQL.setPOS_DISC_TOT(dblPOS_DISC_TOT * val_sign);		slstxhdrSQL.setOTHER_DISC_TOT1(dblOTHER_DISC_TOT1 * val_sign);		slstxhdrSQL.setOTHER_DISC_TOT2(dblOTHER_DISC_TOT2 * val_sign);		slstxhdrSQL.setOTHER_DISC_TOT3(dblOTHER_DISC_TOT3 * val_sign);		slstxhdrSQL.setEXEC_DISC_TOT(dblEXEC_DISC_TOT * val_sign);		slstxhdrSQL.setCARD_DISC_TOT(dblCARD_DISC_TOT * val_sign);		slstxhdrSQL.setGROUP_DISC_TOT(dblGROUP_DISC_TOT * val_sign); // added by stanley 2009-12-16		slstxhdrSQL.setSTDD_DISC_TOT(dblSTDD_DISC_TOT * val_sign); // added by stanley 2009-12-16		slstxhdrSQL.setMFR_DISC_TOT(dblMFR_DISC_TOT * val_sign); // added by stanley 2009-12-16		slstxhdrSQL.setMBR_AUTO_DISC_TOT(dblMBR_AUTO_DISC_TOT * val_sign); // JoeMy 2015-01-21 GST PCR		slstxhdrSQL.setRTC_DISC_TOT(dblRTC_DISC_TOT * val_sign); // Goxz 2017-04-05 POS Member Registration(SRAM041988)-Phase 1		slstxhdrSQL.setPWP_DISC_TOT(dblPWP_DISC_TOT * val_sign); // Goxz 20170810 SRAM071321 PWP		slstxhdrSQL.setDISC_1_TOT(dblDISC_1_TOT * val_sign); // Goxz 20170810 SRAM071321 PWP		slstxhdrSQL.setDISC_2_TOT(dblDISC_2_TOT * val_sign); // Goxz 20170810 SRAM071321 PWP		slstxhdrSQL.setDISC_3_TOT(dblDISC_3_TOT * val_sign); // Goxz 20170810 SRAM071321 PWP		slstxhdrSQL.setDISC_4_TOT(dblDISC_4_TOT * val_sign); // Goxz 20170810 SRAM071321 PWP		slstxhdrSQL.setDISC_5_TOT(dblDISC_5_TOT * val_sign); // Goxz 20170810 SRAM071321 PWP		double tot_disc = dblPROMO_DISC_TOT + dblSTAFF_DISC_TOT				+ dblAUTHORISE_DISC_TOT + dblMEMBER_DISC_TOT + dblPOS_DISC_TOT				+ dblOTHER_DISC_TOT1 + dblOTHER_DISC_TOT2 + dblOTHER_DISC_TOT3				+ dblEXEC_DISC_TOT + dblCARD_DISC_TOT + dblGROUP_DISC_TOT				+ dblSTDD_DISC_TOT + dblMFR_DISC_TOT // added by stanley 2009-12-16				+ dblMBR_AUTO_DISC_TOT // JoeMy 2015-01-21 GST PCR				+ dblRTC_DISC_TOT // Goxz 2017-04-05 POS Member Registration(SRAM041988)-Phase 1				// Goxz 20170810 SRAM071321 PWP - Start				+ dblPWP_DISC_TOT + dblDISC_1_TOT + dblDISC_2_TOT				+ dblDISC_3_TOT + dblDISC_4_TOT + dblDISC_5_TOT;				// Goxz 20170810 SRAM071321 PWP - End		slstxhdrSQL.setEXT_DISC_AMOUNT_TOT(tot_disc * val_sign);		slstxhdrSQL.setEXT_SELL_TOT(_ffSlsPosTypeBRec.getDouble("PI_TOT_AMT") + tot_disc);		slstxhdrSQL.setEXT_NET_SELL_TOT(_ffSlsPosTypeBRec.getDouble("PI_TOT_AMT") * val_sign);		slstxhdrSQL.setROUNDING_AMT(_ffSlsPosTypeBRec.getDouble("PI_RND"));		slstxhdrSQL.setTAX_AMT(_ffSlsPosTypeBRec.getDouble("PI_TAX_AMT"));		slstxhdrSQL.setCHANGE_AMOUNT(_ffSlsPosTypeBRec.getDouble("PI_CHANGE") * val_sign);		slstxhdrSQL.setSALES_TRANS_TIME(_ffSlsPosTypeBRec.getString("PI_TIME"));		slstxhdrSQL.setSALES_CAPTURE_METHOD(IF_Slstxhdr.SALES_CAPTURE_METHODoUpload);		slstxhdrSQL.setSALES_UPDATE_STATUS(IF_Slstxhdr.SALES_UPDATE_STATUSoNo);		// JoeMy 2015-01-21 GST PCR		slstxhdrSQL.setSALES_VAT_AMT_TOT(_ffSlsPosTypeBRec.getDouble("PI_GST_AMT"));		slstxhdrSQL.setREFUND_ORI_TRANS(_ffSlsPosTypeBRec.getString("PI_REFUND_ORI_TRANS"));		slstxhdrSQL.setREFUND_ORI_STORE(_ffSlsPosTypeBRec.getString("PI_REFUND_ORI_STORE"));		slstxhdrSQL.setREFUND_ORI_SALES_DATE(_ffSlsPosTypeBRec.getDate("PI_REFUND_SALES_DATE", "YYYYMMDD"));		// JoeMy 2015-02-13 GST PCR		slstxhdrSQL.setREFUND_RSN_CD(_ffSlsPosTypeBRec.getString("PI_REFUND_RSN_CD"));		slstxhdrSQL.setREFUND_RSN_DESC(_ffSlsPosTypeBRec.getString("PI_REFUND_RSN_DESC"));		// WenTem 2015-12-23 breakset start		slstxhdrSQL.setBREAKSET_FLAG(hdrPackItemFlag);		hdrPackItemFlag = "N";		// WenTem 2015-12-23 breakset end		slstxhdrSQL.setMOMMY_CARD_CODE(_ffSlsPosTypeBRec.getString("PI_MOMMY_CARD").trim()); // Goxz 2017-02-16 AMY PCR – SRAM046010 Mommy Card Implementation		slstxhdrSQL.setPRE_BOOK_NO(_ffSlsPosTypeBRec.getString("PI_PRE_BOOK_NO").trim()); // Goxz 20170803 Pre-Booking                		slstxhdrSQL.setSALES_TRANS_TIME_START(_ffSlsPosTypeBRec.getString("PI_START_TIME").trim()); // Goxz 20170810 First Scan Item Time		slstxhdrSQL.setSALES_TRANS_TIME_END(_ffSlsPosTypeBRec.getString("PI_END_TIME").trim()); // Goxz 20170810 Tender Completion Time		if (rt == 0) {			slstxhdrSQL.insert();		} else {			slstxhdrSQL.update();		}	}                private void updateEMONEYENCRYPAN(FfSlsPosIntf _ffSlsPosTypeBRec)            throws SQLException, Exception {                emoneyencrypanSQL.setVObject((new EmoneyencrypanInfo()).getVObject()); // clear data                                emoneyencrypanSQL.setCOY(slstxhdrSQL.COY());                emoneyencrypanSQL.setCOY_SUB(slstxhdrSQL.COY_SUB());                emoneyencrypanSQL.setSTORE(slstxhdrSQL.STORE());                emoneyencrypanSQL.setSALES_TRANS_DATE(slstxhdrSQL.SALES_TRANS_DATE());                emoneyencrypanSQL.setSTORE_POS_NUMBER(slstxhdrSQL.STORE_POS_NUMBER());                emoneyencrypanSQL.setSTORE_POS_TRANS(slstxhdrSQL.STORE_POS_TRANS());                emoneyencrypanSQL.setENCRYPTED_PAN(_ffSlsPosTypeBRec.getString("PI_ENCRYPTED_PAN").trim());                emoneyencrypanSQL.setMEMBER_CODE(slstxhdrSQL.MEMBER_CODE());                                if (emoneyencrypanSQL.checkKeyExist() == 0) {                        emoneyencrypanSQL.insert();                } else {                        emoneyencrypanSQL.update();                }            }	/**	 * Inserts/Update Type E record data into SLSCSHCLLT	 * 	 * @throws java.sql.SQLException	 *             If exceptions occured when insert/update data to SLSCSHCLLT	 * @param _ffSlsPosTypeERec	 *            Flat file interface for Record Type E	 */	private void updateSLSCSHCLLT(FfSlsPosIntf _ffSlsPosTypeERec)			throws SQLException {		slscshclltSQL.setCOY(strmstSQL.STORE_COY());		slscshclltSQL.setCOY_SUB(strmstSQL.STORE_COY_SUB());		slscshclltSQL.setSTORE(strmstSQL.STORE());		slscshclltSQL.setSALES_TRANS_DATE(pos_sales_trans_date);		slscshclltSQL.setSTORE_POS_NUMBER(_ffSlsPosTypeERec.getString("PI_POS"));		slscshclltSQL.setCASH_TRANS_TYPE(getPaymentTransTypeRecE(_ffSlsPosTypeERec));		slscshclltSQL.setCASH_TRANS_GROUP(CASH_TRANS_GROUP);		slscshclltSQL.setPOST_TRANS_DATE(pos_sales_trans_date);		slscshclltSQL.setPOS_ID(_ffSlsPosTypeERec.getString("PI_POS_ID"));		slscshclltSQL.setPYMNT_SALES(_ffSlsPosTypeERec.getDouble("PI_PYMT_SALES"));		slscshclltSQL.setPYMNT_COUNT(_ffSlsPosTypeERec.getDouble("PI_PYMT_COUNT"));		slscshclltSQL.setLAST_OPR(LAST_OPR);		slscshclltSQL.setLAST_OPR_FUNCT(LAST_OPR_FUNCT);		slscshclltSQL.setEDITABLE("Y");		if (slscshclltSQL.checkKeyExist() == 0) {			slscshclltSQL.insert();		} else {			slscshclltSQL.update();		}	} // updateSLSCSHCLLT	private void updateSLSCSHCLLTUPDATE() throws SQLException {		slscshclltupdateSQL.setCOY(slscshclltSQL.COY());		slscshclltupdateSQL.setCOY_SUB(slscshclltSQL.COY_SUB());		slscshclltupdateSQL.setSTORE(slscshclltSQL.STORE());		slscshclltupdateSQL.setSALES_TRANS_DATE(slscshclltSQL.SALES_TRANS_DATE());		slscshclltupdateSQL.setSTORE_POS_NUMBER(slscshclltSQL.STORE_POS_NUMBER());		slscshclltstrSQL.setSTORE(slscshclltSQL.STORE());		slscshclltstrSQL.setCOY(slscshclltSQL.COY());		slscshclltstrSQL.setCOY_SUB(slscshclltSQL.COY_SUB());		// ADDED BY MAXX		if (qrMisc.compareSqlDate(pos_sales_trans_date, ">=",				sysctlSQL.LAST_DAY_UPDATED()))		// if(sysctlSQL.LAST_DAY_UPDATED().equals(pos_sales_trans_date) )		{			if (slscshclltstrSQL.checkKeyExist() == 0) {				slscshclltupdateSQL.setEDITABLE("N");			} else {				slscshclltupdateSQL.setEDITABLE("Y");			}		} else {			slscshclltupdateSQL.setEDITABLE("Y");		}		// END MAXX		if (slscshclltupdateSQL.checkKeyExist() == 0) {			slscshclltupdateSQL.insert();		} else {			slscshclltupdateSQL.update();		}	}	/**	 * Updates <code>SLSCSHCLLT.EDITABLE</code> to 'N' for Sales Transaction	 * Date which earlier than the transacction date of the sales file.	 * 	 * @throws java.sql.SQLException	 *             If fail to update <code>SLSCSHCLLT.EDITABLE</code>	 */	private void updateSlscshclltEditable() throws SQLException {		// JoeMy 2015-01-21 GST PCR		final String UPDATE_SLSCSHCLLT = "UPDATE SLSCSHCLLTUPDATE SET EDITABLE = 'N' "				+ "WHERE COY = ?  "				+ "AND COY_SUB = ?  "				+ "AND STORE = ?  "				+ "AND ( (SALES_TRANS_DATE < ?) OR (?>? AND SALES_TRANS_DATE BETWEEN ? AND ?) )  "				+ "AND EDITABLE = 'Y' ";		// mod by abu, AU-IM003077423 - Request to allow edit tender collection		// for pass two days, 2014-06-09		// "UPDATE SLSCSHCLLTUPDATE SET EDITABLE = 'N' " +		// "WHERE COY = ? AND COY_SUB = ? AND STORE = ? AND " +		// "SALES_TRANS_DATE < ? AND EDITABLE = 'Y'";		try {			Calendar cal = Calendar.getInstance();			cal.add(Calendar.MONTH, -1);			cal.set(Calendar.DATE, 1);			java.sql.Date firstDateOfPreviousMonth = new java.sql.Date(cal.getTime().getTime());			cal.set(Calendar.DATE, cal.getActualMaximum(Calendar.DATE));			java.sql.Date lastDateOfPreviousMonth = new java.sql.Date(cal.getTime().getTime());			int SYSTendUpdDayLag = Integer.parseInt(profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSTendUpdDayLag"));			// Added by Maxx			int SYSSlsCutOffDay = 0;			// int SYSSlsCutOffDay =			// Integer.parseInt(profitvv_getByPrimaryKey(strmstSQL.STORE_COY(),"SYSCshClltCutOffDay"));			if (slscshclltstrSQL.checkKeyExist() == 0) {				SYSSlsCutOffDay = Integer.parseInt(profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSCshClltCutOffDay"));			} else {				SYSSlsCutOffDay = Integer.parseInt(profitvv_getByPrimaryKey(strmstSQL.STORE_COY(), "SYSSlsCutOffDay"));			}// end Maxx			pstmt = conn.prepareStatement(UPDATE_SLSCSHCLLT);			pstmt.setString(1, strmstSQL.STORE_COY());			pstmt.setString(2, strmstSQL.STORE_COY_SUB());			pstmt.setString(3, strmstSQL.STORE());			// pstmt.setDate(4,			// qrMisc.addDay(pos_sales_trans_date,-(SYSTendUpdDayLag)));comment			// by maxx			pstmt.setDate(4, pos_sales_trans_date);// added by maxx			pstmt.setInt(5, qrMisc.getDay(qrMisc.getSqlSysDate()));			pstmt.setInt(6, SYSSlsCutOffDay);			pstmt.setDate(7, firstDateOfPreviousMonth);			pstmt.setDate(8, lastDateOfPreviousMonth);			pstmt.executeUpdate();			// added by Maxx			if (qrMisc.compareSqlDate(pos_sales_trans_date, ">=", sysctlSQL.LAST_DAY_UPDATED()))			// if(sysctlSQL.LAST_DAY_UPDATED().equals(pos_sales_trans_date))			{				String UpdateTenderQuery = "UPDATE SLSCSHCLLTUPDATE SET EDITABLE = 'Y'"						+ "WHERE  COY = ? "						+ "AND COY_SUB = ? "						+ "AND STORE = ? "						+ "AND SALES_TRANS_DATE = ? - ?"						+ "AND EDITABLE = 'N'  "						+ "AND STORE NOT IN (SELECT DISTINCT STORE FROM SLSCSHCLLTSTR) ";				pstmt = conn.prepareStatement(UpdateTenderQuery);				pstmt.setString(1, strmstSQL.STORE_COY());				pstmt.setString(2, strmstSQL.STORE_COY_SUB());				pstmt.setString(3, strmstSQL.STORE());				pstmt.setDate(4, qrMisc.addDay(pos_sales_trans_date, 1));				pstmt.setInt(5, SYSTendUpdDayLag);				pstmt.executeUpdate();			}// end maxx		} catch (SQLException e) {			e.printStackTrace();			throw (e);		} finally {			try {				if (pstmt != null) {					pstmt.close();					pstmt = null;				}			} catch (SQLException e) {			}		}	} // updateSlscshclltEditable	private void updateSLSCSHDET(FfSlsPosIntf _ffSlsPosTypeCRec)			throws SQLException {		int val_sign = 1; // positive = 1 or negative = -1		slscshdetSQL.setVObject(new SlscshdetInfo().getVObject());		slscshdetSQL.setCOY(strmstSQL.STORE_COY());		slscshdetSQL.setCOY_SUB(strmstSQL.STORE_COY_SUB());		slscshdetSQL.setSTORE(strmstSQL.STORE());		slscshdetSQL.setSALES_TRANS_DATE(pos_sales_trans_date);		slscshdetSQL.setSTORE_POS_NUMBER(_ffSlsPosTypeCRec.getString("PI_POS"));		slscshdetSQL.setSTORE_POS_TRANS(_ffSlsPosTypeCRec.getString("PI_TRANS_NO"));		slscshdetSQL.setCASH_SEQ(++tender_seq_no);		// if the hdr already exist, need to check slscshdet exist or not		// else we can skip checking the slscshdet		if (slstxhdr_exist == true && slscshdetSQL.checkKeyExist() > 0) {			return;		}		slscshdetSQL.setPOST_TRANS_DATE(posting_date);		slscshdetSQL.setCASH_TRANS_GROUP("C"); // default to C		slscshdetSQL.setCASH_TRANS_TYPE(getPaymentTransType(_ffSlsPosTypeCRec));		if (_ffSlsPosTypeCRec.getString("PI_CTYPE").equals("0012")) {			// slscshdetSQL.setCASH_TRANS_TYPE(TRNCashTransType);			val_sign = 1;		} else if (_ffSlsPosTypeCRec.getString("PI_CTYPE").equals("0312")) {			// Aeon pos already provide the amount in -ve			// val_sign = -1;		}		// added by stanley 2009-12-16 (start)		slscshdetSQL.setCASH_TOT(_ffSlsPosTypeCRec.getDouble("PI_PYMT_AMT") * val_sign);		slscshdetSQL.setCASH_EXCHANGE_RATE(_ffSlsPosTypeCRec.getDouble("PI_FOR_CURR_AMT"));		slscshdetSQL.setMERCH_CD(_ffSlsPosTypeCRec.getString("PI_MERCHANT_CODE"));		slscshdetSQL.setTERMINAL_ID(_ffSlsPosTypeCRec.getString("PI_TERMINAL_ID"));		slscshdetSQL.setAPPROVAL_CODE(_ffSlsPosTypeCRec.getString("PI_APP_CODE"));		slscshdetSQL.setSALES_TAX_AMT(_ffSlsPosTypeCRec.getDouble("PI_SALES_TAX_AMT"));		slscshdetSQL.setCDO_NO(_ffSlsPosTypeCRec.getString("PI_CDO_NO"));		slscshdetSQL.setFOREIGN_CURR_AMT(_ffSlsPosTypeCRec.getDouble("PI_FOR_CURR_AMT"));		slscshdetSQL.setRCON_PROCESS("N");		slscshdetSQL.setRCON_BATCH_NO(0);		slscshdetSQL.setCASH_PAY_AMOUNT(_ffSlsPosTypeCRec.getDouble("PI_ACTUAL_AMT") * val_sign); // added by stanley 2009-12-16		// wentem 2016-01-06 Breakset Gift Voucher		if (isVoucherTenderType(txtypmstSQL.PAYMENT_TYPE())) {			slscshdetSQL.setGIFT_VOUCHER_NUMBER(_ffSlsPosTypeCRec.getString("PI_FIL44"));		} else {			slscshdetSQL.setCREDIT_CARD_NUMBER(_ffSlsPosTypeCRec.getString("PI_FIL44")); // added by stanley 2009-12-16		}		slscshdetSQL.setUPDATE_STATUS("N");		slscshdetSQL.setTREAT_PTS_FLAG(_ffSlsPosTypeCRec.getString("PI_TREATS_PTS"));// add by kokjoe 2014-12-05		// AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23 - Start		//slscshdetSQL.setEXCESS_CASH_VAT_CODE(_ffSlsPosTypeCRec.getString("PI_EXCESS_GST_CODE").trim());		//slscshdetSQL.setEXCESS_CASH_VAT_RATE(_ffSlsPosTypeCRec.getDouble("PI_EXCESS_GST_RATE"));		//slscshdetSQL.setEXCESS_CASH_VAT_AMOUNT(_ffSlsPosTypeCRec.getDouble("PI_EXCESS_GST_AMT"));		// AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23 - End                		slscshdetSQL.setLAST_OPR(LAST_OPR);		slscshdetSQL.setLAST_OPR_FUNCT(LAST_OPR_FUNCT);                		slscshdetSQL.insert();	}	private void updateSLSCSHERR(FfSlsPosIntf _ffSlsPosTypeCRec)			throws SQLException {		int val_sign = 1; // positive = 1 or negative = -1		slscsherrSQL.setCOY(strmstSQL.STORE_COY());		slscsherrSQL.setSTORE(strmstSQL.STORE());		slscsherrSQL.setPOST_TRANS_DATE(posting_date);		slscsherrSQL.setSALES_TRANS_DATE(pos_sales_trans_date);		slscsherrSQL.setSTORE_POS_NUMBER(_ffSlsPosTypeCRec.getString("PI_POS"));		slscsherrSQL.setSTORE_POS_TRANS(_ffSlsPosTypeCRec.getString("PI_TRANS_NO"));		slscsherrSQL.setCASH_SEQ(++tender_seq_no);		slscsherrSQL.setCASH_TRANS_GROUP("C"); // default to C		slscsherrSQL.setCASH_TRANS_TYPE(getPaymentTransType(_ffSlsPosTypeCRec));		if (_ffSlsPosTypeCRec.getString("PI_CTYPE").equals("0012")) {			val_sign = 1;		} else if (_ffSlsPosTypeCRec.getString("PI_CTYPE").equals("0312")) {			// slscsherrSQL.setCASH_TRANS_TYPE(TRNCashRetTransType);			// Aeon pos already provide the amount in -ve			// val_sign = -1;		}		slscsherrSQL.setCASH_TOT(_ffSlsPosTypeCRec.getDouble("PI_PYMT_AMT") * val_sign);		slscsherrSQL.setCASH_EXCHANGE_RATE(1.00);		slscsherrSQL.setCASH_PAY_AMOUNT(_ffSlsPosTypeCRec.getDouble("PI_ACTUAL_AMT") * val_sign); // added by stanley 2009-12-16		// wentem 2016-01-06 Breakset Gift Voucher		if (isVoucherTenderType(txtypmstSQL.PAYMENT_TYPE())) {			slscsherrSQL.setGIFT_VOUCHER_NUMBER(_ffSlsPosTypeCRec.getString("PI_FIL44")); // JoeMy 2013-10-12 Gift Voucher From			// slscsherrSQL.setOTHER_USER(			// _ffSlsPosTypeCRec.getString("PI_TO_GV_NO")); //JoeMy 2013-10-12 Gift Voucher To		} else {			slscsherrSQL.setCREDIT_CARD_NUMBER(_ffSlsPosTypeCRec.getString("PI_FIL44"));		}		slscsherrSQL.setTERMINAL_ID(_ffSlsPosTypeCRec.getString("PI_TERMINAL_ID"));		slscsherrSQL.setMERCH_CD(_ffSlsPosTypeCRec.getString("PI_MERCHANT_CODE"));		slscsherrSQL.setAPPROVAL_CODE(_ffSlsPosTypeCRec.getString("PI_APP_CODE"));		slscsherrSQL.setTREAT_PTS_FLAG(_ffSlsPosTypeCRec.getString("PI_TREATS_PTS"));                // AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23 - Start                //slscsherrSQL.setEXCESS_CASH_VAT_CODE(_ffSlsPosTypeCRec.getString("PI_EXCESS_GST_CODE").trim());                //slscsherrSQL.setEXCESS_CASH_VAT_RATE(_ffSlsPosTypeCRec.getDouble("PI_EXCESS_GST_RATE"));                //slscsherrSQL.setEXCESS_CASH_VAT_AMOUNT(_ffSlsPosTypeCRec.getDouble("PI_EXCESS_GST_AMT"));                // AlanHeng ACS E-Wallet and E-Money Member Recognition 2018-03-23 - End                		slscsherrSQL.setLAST_OPR(LAST_OPR);		slscsherrSQL.setLAST_OPR_FUNCT(LAST_OPR_FUNCT);		if (slscsherrSQL.checkKeyExist() == 0) {			slscsherrSQL.insert();		} else {			slscsherrSQL.update();		}	}	private void updateSLSCSHDIFF(FfSlsPosIntf _ffSlsPosTypeDRec)			throws SQLException {		slscshdiffSQL.setCOY(strmstSQL.STORE_COY());		slscshdiffSQL.setCOY_SUB(strmstSQL.STORE_COY_SUB());		slscshdiffSQL.setSTORE(strmstSQL.STORE());		slscshdiffSQL.setSALES_TRANS_DATE(pos_sales_trans_date);		slscshdiffSQL.setPOS_ID(_ffSlsPosTypeDRec.getString("PI_POS"));		slscshdiffSQL.setPOS_TRANS(_ffSlsPosTypeDRec.getString("PI_TRANS_NO"));		slscshdiffSQL.setCASHIER_ID(_ffSlsPosTypeDRec.getString("PI_CASHIER_ID"));		slscshdiffSQL.setCASH_LOAN(_ffSlsPosTypeDRec.getDouble("PI_CASH_LOAN"));		slscshdiffSQL.setCASH_COLLECTION(_ffSlsPosTypeDRec.getDouble("PI_CASH_COLLECTION"));		slscshdiffSQL.setCASH_ACTUAL_SALES(_ffSlsPosTypeDRec.getDouble("PI_CASH_ACTUAL_SALES"));		slscshdiffSQL.setCASH_LAST_COLLECTION(_ffSlsPosTypeDRec.getDouble("PI_CASH_LAST_COLLECTION"));		slscshdiffSQL.setLAST_OPR(LAST_OPR);		slscshdiffSQL.setLAST_OPR_FUNCT(LAST_OPR_FUNCT);		if (slscshdiffSQL.checkKeyExist() == 0) {			slscshdiffSQL.insert();		} else {			if (qrMath.compare(slscshdiffSQL.CASH_ACTUAL_SALES(), "!=", 0)) // Awkw 2007-04-01			{				slscshdiffSQL.update();			}		}	}	private void updateSLSTXACS(FfSlsPosIntf _ffSlsPosTypeCRec)			throws SQLException {		slstxacsSQL.setCOY(strmstSQL.STORE_COY());		slstxacsSQL.setCOY_SUB(strmstSQL.STORE_COY_SUB());		slstxacsSQL.setSTORE(strmstSQL.STORE());		slstxacsSQL.setSALES_TRANS_DATE(pos_sales_trans_date);		slstxacsSQL.setSTORE_POS_NUMBER(_ffSlsPosTypeCRec.getString("PI_POS"));		slstxacsSQL.setSTORE_POS_TRANS(_ffSlsPosTypeCRec.getString("PI_TRANS_NO"));		slstxacsSQL.setCASH_SEQ(slscshdetSQL.CASH_SEQ());		slstxacsSQL.setPOST_TRANS_DATE(pos_sales_trans_date);		slstxacsSQL.setSALES_TRANS_TYPE(_ffSlsPosTypeCRec.getString("PI_CTYPE"));		slstxacsSQL.setCARD_NUMBER(_ffSlsPosTypeCRec.getString("PI_FIL44"));		slstxacsSQL.setSALES_TRANS_TIME(qrMisc.rightFillZero(slstxhdrSQL.SALES_TRANS_TIME(), 6));		slstxacsSQL.setTRANS_AMT(_ffSlsPosTypeCRec.getDouble("PI_ACTUAL_AMT"));		slstxacsSQL.setTRANS_DISC_AMT(_ffSlsPosTypeCRec.getDouble("PI_DISC_AMT"));		slstxacsSQL.setAPPROVAL_CODE(_ffSlsPosTypeCRec.getString("PI_APP_CODE"));		slstxacsSQL.setDEBIT_TYPE(_ffSlsPosTypeCRec.getString("PI_DEBIT_TYPE"));		slstxacsSQL.setINSTALLMENT_TERM("01");		slstxacsSQL.setTRANS_DISC_RATE(_ffSlsPosTypeCRec.getDouble("PI_DISC_RATE"));		slstxacsSQL.setECO_POINT_STATUS(_ffSlsPosTypeCRec.getString("PI_ECO_POINT"));		slstxacsSQL.setAPPROVAL_TYPE(_ffSlsPosTypeCRec.getString("PI_APPRO_TYPE"));		slstxacsSQL.setNON_DISC_AMT(_ffSlsPosTypeCRec.getDouble("PI_NON_DISC_AMT"));		slstxacsSQL.setLAST_OPR(LAST_OPR);		slstxacsSQL.setLAST_OPR_FUNCT(LAST_OPR_FUNCT);		slstxacsSQL.insert();	}	private void updateSlstxhdr_TOTAL_TENDER() throws SQLException {		try {			String update = "UPDATE SLSTXHDR H SET TOTAL_TENDER = " + "("					+ "SELECT Sum(CASH_TOT) " + "FROM SLSCSHDET C "					+ "WHERE C.STORE = H.STORE "					+ "AND C.SALES_TRANS_DATE = H.SALES_TRANS_DATE "					+ "AND C.STORE_POS_NUMBER = H.STORE_POS_NUMBER "					+ "AND C.STORE_POS_TRANS = H.STORE_POS_TRANS "					+ "AND C.STORE = ? AND C.SALES_TRANS_DATE = ? " + ")"					+ " WHERE H.STORE = ? AND H.SALES_TRANS_DATE = ?";			// " AND H.SALES_CAPTURE_METHOD = 'U'" +			// " AND H.SALES_UPDATE_STATUS = 'N'";			pstmt = conn.prepareStatement(update);			pstmt.setString(1, strmstSQL.STORE());			pstmt.setDate(2, pos_sales_trans_date);			pstmt.setString(3, strmstSQL.STORE());			pstmt.setDate(4, pos_sales_trans_date);			pstmt.executeUpdate();		} finally {			try {				if (pstmt != null) {					pstmt.close();				}			} catch (Exception e) {			}			pstmt = null;		}	}	private String getStoreCode(String store) {		/*		 * now they use 4 digit for store code if(sysSystemUser.isAeonCn())		 * return "0" + store; else		 */		if (sysSystemUser.isAeonTw()) {			return coysubmstSQL.COY_PREFIX() + store;		} else {			return store;		}	}	private void retrieveCoysubmst(String coy, String coysub)			throws SQLException {		coysubmstSQL.setCOY(coy);		coysubmstSQL.setCOY_SUB(coysub);		if (coysubmstSQL.getByKey() == 0) {			throw new SQLException("Coysubmst record does not exist. COY=" + coy + " COY_SUB=" + coysub);		}	}	private String getPaymentTransType(FfSlsPosIntf _ffSlsPosTypeCRec)			throws SQLException {		if (_ffSlsPosTypeCRec.getString("PI_CTYPE").equals("0012")) // 0012 -sales		{			return (_ffSlsPosTypeCRec.getString("PI_PYMT_TYPE") + "SLS");		} else if (_ffSlsPosTypeCRec.getString("PI_CTYPE").equals("0312")) // 0012 -sales		{			return (_ffSlsPosTypeCRec.getString("PI_PYMT_TYPE") + "RTN");		} else {			return (_ffSlsPosTypeCRec.getString("PI_PYMT_TYPE") + "ERR");		}	}	/**	 * Gets the Payment Transaction Type for Record type E	 * 	 * @throws SQLException	 *             If exception occured when getting the Payment Transaction	 *             Type for Record Type E	 * @return Payment Transaction Type with appended "SLS" for Sales type or	 *         "RTN" for Return type	 * @param _ffSlsPosTypeERec	 *            Sales file interface for record type E	 */	private String getPaymentTransTypeRecE(FfSlsPosIntf _ffSlsPosTypeERec)			throws SQLException {		String strSlsType = null;		String strPymntType = _ffSlsPosTypeERec.getString("PI_SALES_TYPE");		/** Sales Type */		if (strPymntType != null				&& strPymntType.trim().equals(REC_E_PYMNT_TYPE_SALES_CODE)) {			strSlsType = REC_E_PYMNT_TYPE_SALES;		}		/** Return Type */		else if (strPymntType != null				&& strPymntType.trim().equals(REC_E_PYMNT_TYPE_RETURN_CODE)) {			strSlsType = REC_E_PYMNT_TYPE_RETURN;		} else {			strSlsType = "";		}		return _ffSlsPosTypeERec.getString("PI_PYMT_TYPE").concat(strSlsType);	} // getPaymentTypeTransType	public void setStatusWriter(StatusWriter _wrter) {		writer = _wrter;	}	private void writeln(String msg) {		if (this.writer != null) {			writer.write(msg);		}		System.out.println(msg);	}	// JoeMy 2015-01-21 GST PCR	private void insertSLSINVHDR(FfSlsPosIntf _ffSlsPosTypeFRec)			throws SQLException {		SlsinvhdrInfo slsinvhdrInfo = new SlsinvhdrInfo();		slsinvhdrSQL.setVObject(slsinvhdrInfo.getVObject());		slsinvhdrSQL.setCOY(strmstSQL.STORE_COY());		slsinvhdrSQL.setCOY_SUB(strmstSQL.STORE_COY_SUB());		slsinvhdrSQL.setSTORE(strmstSQL.STORE());		slsinvhdrSQL.setSALES_TRANS_DATE(pos_sales_trans_date);		slsinvhdrSQL.setPROCESS_ID(slsinvhdrSQL.getPROCESS_ID(strmstSQL.STORE_COY(), strmstSQL.STORE()));		slsinvhdrSQL.setFORM(qrMisc.trimLeft(ffSlsPosTypeFRec.getString("PI_INV_FORM")));		slsinvhdrSQL.setSERIAL_NO(qrMisc.trimLeft(_ffSlsPosTypeFRec.getString("PI_INV_SERIAL")));		slsinvhdrSQL.setINVOICE_NO(qrMisc.trimLeft(_ffSlsPosTypeFRec.getString("PI_INV_NO")));		slsinvhdrSQL.setINVOICE_TYPE("S"); // Default S - Sales		slsinvhdrSQL.setINPUT_TYPE("U"); // Default U - Upload		slsinvhdrSQL.setSTORE_POS_NUMBER(_ffSlsPosTypeFRec.getString("PI_POS"));		slsinvhdrSQL.setSTORE_POS_TRANS(_ffSlsPosTypeFRec.getString("PI_TRANS_NO"));		slsinvhdrSQL.setINVOICE_DATE(pos_sales_trans_date);		slsinvhdrSQL.setCREATED_DATE(sysctlSQL.getLAST_DAY_UPDATEDPlusOne()); // JoeMy 2014-01-15 new field		slsinvhdrSQL.setCREATED_BY(SYSSlsInvGenerator);		slsinvhdrSQL.setCREATED_METHOD("U"); // Default U - Upload		slsinvhdrSQL.setSTATUS("U"); // Default U - Updated		// Encoding Issue, ISO-8859-1 is based on File Reader Encoding, refer		// txtFileRead.java -- START		slsinvhdrSQL.setCUSTOMER_NAME(DBConvert.convert(_ffSlsPosTypeFRec.getString("PI_CUST_NAME"), "ISO-8859-1", SYSPosUploadEncode));		slsinvhdrSQL.setCOMPANY_NAME(DBConvert.convert(_ffSlsPosTypeFRec.getString("PI_CUST_COMPANY"), "ISO-8859-1", SYSPosUploadEncode));		slsinvhdrSQL.setADDRESS(DBConvert.convert(_ffSlsPosTypeFRec.getString("PI_CUST_ADDRS"), "ISO-8859-1", SYSPosUploadEncode));		// -- END		slsinvhdrSQL.setTAX_CODE(_ffSlsPosTypeFRec.getString("PI_CUST_TAX_CODE"));		slsinvhdrSQL.setPAYMENT_METHOD(_ffSlsPosTypeFRec.getString("PI_PYMT_METHOD"));		slsinvhdrSQL.setTEL_NO(_ffSlsPosTypeFRec.getString("PI_CUST_TEL_NO"));		if (_ffSlsPosTypeFRec.getDate("PI_INV_PRINT_DATE", "YYYYMMDD") == null) {			slsinvhdrSQL.setPRINTED_DATE(pos_sales_trans_date);		} else {			slsinvhdrSQL.setPRINTED_DATE(_ffSlsPosTypeFRec.getDate("PI_INV_PRINT_DATE", "YYYYMMDD"));		}		slsinvhdrSQL.setREMARKS(_ffSlsPosTypeFRec.getString("PI_REFUND_REMARK"));		slsinvhdrSQL.setPRINTED_BY(SYSSlsInvGenerator);		slsinvhdrSQL.setPRINTED_COUNT(1);		slsinvhdrSQL.setCONFIRM_DATE(pos_sales_trans_date);		slsinvhdrSQL.setCONFIRM_BY("POS");		slsinvhdrSQL.setLAST_OPR(LAST_OPR);		slsinvhdrSQL.setLAST_OPR_DATE(qrMisc.getSqlSysDate());		slsinvhdrSQL.setLAST_OPR_FUNCT(LAST_OPR_FUNCT);		slsinvhdrSQL.setLAST_VERSION(qrMisc.getSqlSysDate().getTime());		slsinvhdrSQL.insert();	}	private void insertSLSINVDET() throws SQLException {		final String INSERT_SLSINVDET = " INSERT INTO SLSINVDET                                                                                                                                        "				+ " SELECT COY, COY_SUB, STORE, SALES_TRANS_DATE, ? AS PROCESS_ID, STORE_POS_NUMBER, STORE_POS_TRANS, SEQ_NO, SALES_TRANS_GROUP, SALES_TRANS_TYPE,               "				+ " UPDATE_FLAG, SALES_VAT_CODE, SALES_VAT_RATE, QTY, INV_AMT_WVAT, INV_AMT_WOVAT, INV_VAT_AMOUNT,                                                               "				+ " ? AS LAST_OPR, TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'),'YYYY-MM-DD') AS LAST_OPR_DATE, 'SALES_PROCESS' AS LAST_OPR_FUNTC, ? AS LAST_VERSION, INV_DISC_AMOUNT   "				+ " FROM                                                                                                                                                         "				+ " (                                                                                                                                                            "				+ " SELECT SH.COY, SH.COY_SUB, SH.STORE, SH.SALES_TRANS_DATE, SH.STORE_POS_NUMBER, SH.STORE_POS_TRANS,                                                           "				+ " SD.SALES_TRANS_GROUP, SD.SALES_TRANS_TYPE, SD.UPDATE_FLAG, SD.SALES_VAT_CODE, SD.SALES_VAT_RATE,                                                             "				+ " NVL(SUM(CASE WHEN SD.BREAKSET_FLAG IS NOT NULL AND SD.BREAKSET_FLAG ='Y' THEN SD.POS_QTY ELSE SD.QTY_SOLD END),0) AS QTY,                                     "				+ " Nvl(Sum(SD.EXT_NET_SALES),0) AS INV_AMT_WVAT, Nvl(Sum(SD.EXT_NET_SALES - SD.SALES_VAT_AMOUNT),0) AS INV_AMT_WOVAT,                                           "				+ " Nvl(Sum(SALES_VAT_AMOUNT),0) AS INV_VAT_AMOUNT,                                                                                                              "				+ " Row_Number() OVER (PARTITION BY SH.COY, SH.COY_SUB, SH.STORE, SH.SALES_TRANS_DATE, SH.STORE_POS_NUMBER, SH.STORE_POS_TRANS                                   "				+ " ORDER BY LPad(SD.SALES_VAT_CODE,99)) AS SEQ_NO,                                                                                                              "				+ " Nvl(Sum(SD.EXT_DISC_AMOUNT),0) AS INV_DISC_AMOUNT                                                                                                            "				+ " FROM SLSTXHDR SH, SLSTXDET SD                                                                                                                                "				+ " WHERE SH.COY = SD.COY                                                                                                                                        "				+ " AND SH.COY_SUB = SD.COY_SUB                                                                                                                                  "				+ " AND SH.STORE = SD.STORE                                                                                                                                      "				+ " AND SH.SALES_TRANS_DATE = SD.SALES_TRANS_DATE                                                                                                                "				+ " AND SH.STORE_POS_NUMBER = SD.STORE_POS_NUMBER                                                                                                                "				+ " AND SH.STORE_POS_TRANS = SD.STORE_POS_TRANS                                                                                                                  "				+ " AND SH.COY = ?                                                                                                                                               "				+ " AND SH.COY_SUB = ?                                                                                                                                           "				+ " AND SH.STORE = ?                                                                                                                                             "				+ " AND SH.SALES_TRANS_DATE = ?                                                                                                                                  "				+ " AND SH.STORE_POS_NUMBER = ?                                                                                                                                  "				+ " AND SH.STORE_POS_TRANS = ?                                                                                                                                   "				+ " AND SD.UPDATE_FLAG = ?                                                                                                                                       "				+ " GROUP BY SH.COY, SH.COY_SUB, SH.STORE, SH.SALES_TRANS_DATE, SH.STORE_POS_NUMBER, SH.STORE_POS_TRANS,                                                         "				+ " SD.SALES_TRANS_GROUP, SD.SALES_TRANS_TYPE, SD.UPDATE_FLAG, SD.SALES_VAT_CODE, SD.SALES_VAT_RATE                                                              "				+ " )                                                                                                                                                            ";		try {			int i = 1;			pstmt = conn.prepareStatement(INSERT_SLSINVDET);			pstmt.setString(i++, slsinvhdrSQL.PROCESS_ID());			pstmt.setString(i++, LAST_OPR);			pstmt.setLong(i++, qrMisc.getSqlSysDate().getTime());			pstmt.setString(i++, slsinvhdrSQL.COY());			pstmt.setString(i++, slsinvhdrSQL.COY_SUB());			pstmt.setString(i++, slsinvhdrSQL.STORE());			pstmt.setDate(i++, slsinvhdrSQL.SALES_TRANS_DATE());			pstmt.setString(i++, slsinvhdrSQL.STORE_POS_NUMBER());			pstmt.setString(i++, slsinvhdrSQL.STORE_POS_TRANS());			pstmt.setString(i++, slsinvhdrSQL.INPUT_TYPE());			pstmt.executeUpdate();		} catch (SQLException e) {			e.printStackTrace();			throw (e);		} finally {			try {				if (pstmt != null) {					pstmt.close();					pstmt = null;				}			} catch (SQLException e) {			}		}	}	private void insertSLSINVDETTOT() throws SQLException {		final String INSERT_SLSINVDETTOT = " INSERT INTO SLSINVDETTOT                                                                                                      "				+ " SELECT COY, COY_SUB, STORE, SALES_TRANS_DATE, ? AS PROCESS_ID, SEQ_NO, INV_VAT_CODE, INV_VAT_RATE, ? AS DESCRIPTION,          "				+ " QTY, INV_AMT_WVAT, INV_AMT_WOVAT, INV_VAT_AMOUNT,                                                                             "				+ " ? AS LAST_OPR, TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'),'YYYY-MM-DD') AS LAST_OPR_DATE, ? AS LAST_OPR_FUNTC, ? AS LAST_VERSION,  "				+ " INV_DISC_AMOUNT                                                                                                               "				+ " FROM                                                                                                                          "				+ " (                                                                                                                             "				+ " SELECT COY, COY_SUB, STORE, SALES_TRANS_DATE, PROCESS_ID, INV_VAT_CODE, INV_VAT_RATE, Nvl(Sum(QTY),0) AS QTY,                 "				+ " Nvl(Sum(INV_AMT_WVAT),0) AS INV_AMT_WVAT, Nvl(Sum(INV_AMT_WOVAT),0) AS INV_AMT_WOVAT,                                         "				+ " Nvl(Sum(INV_VAT_AMOUNT),0) AS INV_VAT_AMOUNT,                                                                                 "				+ " Row_Number() OVER (PARTITION BY COY, COY_SUB, STORE, SALES_TRANS_DATE, PROCESS_ID                                             "				+ " ORDER BY LPad(INV_VAT_CODE,99)) AS SEQ_NO,                                                                                    "				+ " Nvl(Sum(INV_DISC_AMOUNT),0) AS INV_DISC_AMOUNT                                                                                "				+ " FROM SLSINVDET                                                                                                                "				+ " WHERE COY = ?                                                                                                                 "				+ " AND COY_SUB = ?                                                                                                               "				+ " AND STORE = ?                                                                                                                 "				+ " AND SALES_TRANS_DATE = ?                                                                                                      "				+ " AND PROCESS_ID = ?                                                                                                            "				+ " GROUP BY COY, COY_SUB, STORE, SALES_TRANS_DATE, PROCESS_ID,  INV_VAT_CODE, INV_VAT_RATE                                       "				+ " )                                                                                                                             ";		try {			int i = 1;			pstmt = conn.prepareStatement(INSERT_SLSINVDETTOT);			pstmt.setString(i++, slsinvhdrSQL.PROCESS_ID());			pstmt.setString(i++, SYSDefPosSlsInvDesc);			pstmt.setString(i++, LAST_OPR);			pstmt.setString(i++, LAST_OPR_FUNCT);			pstmt.setLong(i++, qrMisc.getSqlSysDate().getTime());			pstmt.setString(i++, slsinvhdrSQL.COY());			pstmt.setString(i++, slsinvhdrSQL.COY_SUB());			pstmt.setString(i++, slsinvhdrSQL.STORE());			pstmt.setDate(i++, slsinvhdrSQL.SALES_TRANS_DATE());			pstmt.setString(i++, slsinvhdrSQL.PROCESS_ID());			pstmt.executeUpdate();		} catch (SQLException e) {			e.printStackTrace();			throw (e);		} finally {			try {				if (pstmt != null) {					pstmt.close();					pstmt = null;				}			} catch (SQLException e) {			}		}	}	private void updateSLSINVHDR() throws SQLException {		int qtyTotal = 0;		double invAmtWvatTot = 0;		double invAmtWovatTot = 0;		double invVatAmtTot = 0;		double invDiscAmtTot = 0;		ResultSet rs = null;		PreparedStatement pstate = null;		final String GET_SLSINVDEt = " SELECT Nvl(Sum(QTY),0) AS QTY,                                                          "				+ " Nvl(Sum(INV_AMT_WVAT),0) AS INV_AMT_WVAT, Nvl(Sum(INV_AMT_WOVAT),0) AS INV_AMT_WOVAT,   "				+ " Nvl(Sum(INV_VAT_AMOUNT),0) AS INV_VAT_AMOUNT,											 "				+ " Nvl(Sum(INV_DISC_AMOUNT),0) AS INV_DISC_AMOUNT                                          "				+ " FROM SLSINVDET                                                                          "				+ " WHERE COY = ?                                                             				 "				+ " AND COY_SUB = ?                                                        				 "				+ " AND STORE = ?                                                          				 "				+ " AND SALES_TRANS_DATE = ?                                     							 "				+ " AND PROCESS_ID = ?                                                  					 "				+ " GROUP BY COY, COY_SUB, STORE, SALES_TRANS_DATE, PROCESS_ID                              ";		try {			int i = 1;			pstate = conn.prepareStatement(GET_SLSINVDEt);			pstate.setString(i++, slsinvhdrSQL.COY());			pstate.setString(i++, slsinvhdrSQL.COY_SUB());			pstate.setString(i++, slsinvhdrSQL.STORE());			pstate.setDate(i++, slsinvhdrSQL.SALES_TRANS_DATE());			pstate.setString(i++, slsinvhdrSQL.PROCESS_ID());			rs = pstate.executeQuery();			if (rs != null && rs.next()) {				qtyTotal = rs.getInt("QTY");				invAmtWvatTot = rs.getDouble("INV_AMT_WVAT");				invAmtWovatTot = rs.getDouble("INV_AMT_WOVAT");				invVatAmtTot = rs.getDouble("INV_VAT_AMOUNT");				invDiscAmtTot = rs.getDouble("INV_DISC_AMOUNT");			}			slsinvhdrSQL.setQTY_TOT(qtyTotal);			slsinvhdrSQL.setINV_AMT_WVAT_TOT(invAmtWvatTot);			slsinvhdrSQL.setINV_AMT_WOVAT_TOT(invAmtWovatTot);			slsinvhdrSQL.setINV_VAT_AMOUNT_TOT(invVatAmtTot);			slsinvhdrSQL.setINV_DISC_AMOUNT_TOT(invDiscAmtTot);			if (slsinvhdrSQL.INV_AMT_WVAT_TOT() >= 0) {				slsinvhdrSQL.setINV_TYPE("I");			} else {				slsinvhdrSQL.setINV_TYPE("C");			}			slsinvhdrSQL.update();		} catch (SQLException e) {			e.printStackTrace();			throw (e);		} finally {			try {				if (rs != null)					rs.close();			} catch (Exception e) {			}			rs = null;			try {				if (pstate != null)					pstate.close();			} catch (Exception e) {			}			pstate = null;		}	}	private void updateSLSTXHDR_INVSLS() throws SQLException {		SlstxhdrInfo slstxhdrInfo = new SlstxhdrInfo();		slstxhdrSQL.setVObject(slstxhdrInfo.getVObject());		slstxhdrSQL.setCOY(slsinvhdrSQL.COY());		slstxhdrSQL.setCOY_SUB(slsinvhdrSQL.COY_SUB());		slstxhdrSQL.setSTORE(slsinvhdrSQL.STORE());		slstxhdrSQL.setSALES_TRANS_DATE(slsinvhdrSQL.SALES_TRANS_DATE());		slstxhdrSQL.setSTORE_POS_NUMBER(slsinvhdrSQL.STORE_POS_NUMBER());		slstxhdrSQL.setSTORE_POS_TRANS(slsinvhdrSQL.STORE_POS_TRANS());		if (slstxhdrSQL.getByKeyForUpdate() > 0) {			slstxhdrSQL.setPROCESS_ID(slsinvhdrSQL.PROCESS_ID());			slstxhdrSQL.setFORM(slsinvhdrSQL.FORM());			slstxhdrSQL.setSERIAL_NO(slsinvhdrSQL.SERIAL_NO());			slstxhdrSQL.setINVOICE_NO(slsinvhdrSQL.INVOICE_NO());			slstxhdrSQL.update();		}	}	private void updateSLSTXHDR_INVSLS_REFUND(FfSlsPosIntf _ffSlsPosTypeFRec)			throws SQLException {		SlstxhdrInfo slstxhdrInfo = new SlstxhdrInfo();		slstxhdrSQL.setVObject(slstxhdrInfo.getVObject());		slstxhdrSQL.setCOY(strmstSQL.STORE_COY());		slstxhdrSQL.setCOY_SUB(strmstSQL.STORE_COY_SUB());		slstxhdrSQL.setSTORE(strmstSQL.STORE());		slstxhdrSQL.setSALES_TRANS_DATE(pos_sales_trans_date);		slstxhdrSQL.setSTORE_POS_NUMBER(_ffSlsPosTypeFRec.getString("PI_POS"));		slstxhdrSQL.setSTORE_POS_TRANS(_ffSlsPosTypeFRec.getString("PI_TRANS_NO"));		if (slstxhdrSQL.getByKeyForUpdate() > 0) {			slstxhdrSQL.setREFUND_FORM(qrMisc.trimLeft(_ffSlsPosTypeFRec.getString("PI_REFUND_INV_FROM")));			slstxhdrSQL.setREFUND_SERIAL_NO(qrMisc.trimLeft(_ffSlsPosTypeFRec.getString("PI_REFUND_INV_SERIAL")));			slstxhdrSQL.setREFUND_INVOICE_NO(qrMisc.trimLeft(_ffSlsPosTypeFRec.getString("PI_REF_INV_NO")));			slstxhdrSQL.update();		}	}	// Goxz 20170803 Pre-Booking - Start	private void insertPREBOOKHDR() throws SQLException, Exception {		int pb_count = 0;		prebookhdrSQL.setCOY(slstxhdrSQL.COY());		prebookhdrSQL.setCOY_SUB(slstxhdrSQL.COY_SUB());		prebookhdrSQL.setSTORE(slstxhdrSQL.STORE());		prebookhdrSQL.setBOOK_NO(slstxhdrSQL.PRE_BOOK_NO());		pb_count = prebookhdrSQL.getBookNoForUpdate();		if (pb_count == 0) {			prebookhdrSQL.setPROCESS_ID(prebookhdrSQL.getPROCESS_ID(prebookhdrSQL.COY(), prebookhdrSQL.STORE(), LAST_OPR, LAST_OPR_FUNCT));			prebookhdrSQL.setBOOK_DATE(slstxhdrSQL.SALES_TRANS_DATE());			prebookhdrSQL.setCREATED_DATE(sysctlSQL.getLAST_DAY_UPDATEDPlusOne());			prebookhdrSQL.setCREATED_BY(SYSPrebookGenerator);			prebookhdrSQL.setCREATED_METHOD("U");			prebookhdrSQL.setSTATUS("O"); // Open status for pre-booking sales (when receive deposit)		} else {			curr_prebookhdrSQL.setVObject((new PrebookhdrInfo()).getVObject()); // clear data			curr_prebookhdrSQL.setVObject((Vector) prebookhdrSQL.getVObject().clone()); // set current prebookhdr before update		}		prebookhdrSQL.setSTORE_POS_TRANS_1(slstxhdrSQL.STORE_POS_TRANS()); // keep receipt number for pre-booking sales		prebookhdrSQL.setLAST_OPR(LAST_OPR);		prebookhdrSQL.setLAST_OPR_FUNCT(LAST_OPR_FUNCT);		if (pb_count == 0) {			prebookhdrSQL.insert();		} else {			prebookhdrSQL.update();			prebookhdrlogger.logEditRecord(curr_prebookhdrSQL, prebookhdrSQL);		}	}	private void insertPREBOOKDEP() throws SQLException, Exception {		PreparedStatement pb_pstate = null;		String pb_query = "INSERT INTO PREBOOKDEP ( "				+ "COY, COY_SUB, STORE, SALES_TRANS_DATE, STORE_POS_NUMBER, STORE_POS_TRANS, SALES_SEQ, BOOK_NO, POST_TRANS_DATE, "				+ "SALES_TRANS_GROUP, SALES_TRANS_TYPE, ITEM_GROUP, SHORT_SKU, BARCODE, SALES_PERSON, QTY_SOLD, UNIT_SELL, SALES_SELL_UNIT, "				+ "CURRENT_RETAIL, EXT_SELL, DISC_TYPE_CODE, PROMO_DISC, STAFF_DISC, AUTHORISE_DISC, MEMBER_DISC, POS_DISC, OTHER_DISC1, "				+ "OTHER_DISC2, OTHER_DISC3, EXT_DISC_AMOUNT, EXT_NET_SALES, SALES_VAT_CODE, SALES_VAT_RATE, SALES_VAT_AMOUNT, EXT_DISC_VAT, "				+ "UPDATE_FLAG, UPDATE_STATUS, STAFF_ID, SALES_DOA, EXEC_DISC, CARD_DISC, LAST_OPR, LAST_OPR_DATE, LAST_OPR_FUNCT, LAST_VERSION, "				+ "VR_PUR_PROCESS, JCSPECIAL_DISC, JCDAY, DISCPERIOD, NEWSTR, ANNISLS, VN_BEARING_JCSPECIAL, VN_BEARING_JCDAY, "				+ "VN_BEARING_DISCPERIOD, VN_BEARING_NEWSTR, VN_BEARING_ANNISLS, BEARING_PROCESS, PRCCHG_MEMBER_DISC, PRCCHG_GROUP_DISC, "				+ "GROUP_DISC, PRCCHG_PROMO_DISC, STDD_DISC, MFR_DISC, PRCCHG_MIX_MATCH_DISC, PRIVILLEGE_MEM, PRICE_OVER_WRITE, SALES_TAX_RATE, "				+ "SALES_TAX_AMT, MBR_AUTO_DISC "				+ ") "				+ "SELECT D.COY, D.COY_SUB, D.STORE, D.SALES_TRANS_DATE, D.STORE_POS_NUMBER, D.STORE_POS_TRANS, D.SALES_SEQ, H.PRE_BOOK_NO AS BOOK_NO, "				+ "D.POST_TRANS_DATE, D.SALES_TRANS_GROUP, D.SALES_TRANS_TYPE, D.ITEM_GROUP, D.SHORT_SKU, D.BARCODE, D.SALES_PERSON, "				+ "D.QTY_SOLD, D.UNIT_SELL, D.SALES_SELL_UNIT, D.CURRENT_RETAIL, D.EXT_SELL, D.DISC_TYPE_CODE, D.PROMO_DISC, D.STAFF_DISC, D.AUTHORISE_DISC, "				+ "D.MEMBER_DISC, D.POS_DISC, D.OTHER_DISC1, D.OTHER_DISC2, D.OTHER_DISC3, D.EXT_DISC_AMOUNT, D.EXT_NET_SALES, "				+ "D.SALES_VAT_CODE, D.SALES_VAT_RATE, D.SALES_VAT_AMOUNT, D.EXT_DISC_VAT, D.UPDATE_FLAG, '" + prebookhdrSQL.STATUS() + "' UPDATE_STATUS, D.STAFF_ID, "				+ "D.SALES_DOA, D.EXEC_DISC, D.CARD_DISC, ? LAST_OPR, TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'),'YYYY-MM-DD') LAST_OPR_DATE, "				+ "? LAST_OPR_FUNCT, To_Number(JLAST_VERSION()) LAST_VERSION, D.VR_PUR_PROCESS, D.JCSPECIAL_DISC, D.JCDAY, "				+ "D.DISCPERIOD, D.NEWSTR, D.ANNISLS, D.VN_BEARING_JCSPECIAL, D.VN_BEARING_JCDAY, D.VN_BEARING_DISCPERIOD, D.VN_BEARING_NEWSTR, "				+ "D.VN_BEARING_ANNISLS, D.BEARING_PROCESS, D.PRCCHG_MEMBER_DISC, D.PRCCHG_GROUP_DISC, D.GROUP_DISC, D.PRCCHG_PROMO_DISC, "				+ "D.STDD_DISC, D.MFR_DISC, D.PRCCHG_MIX_MATCH_DISC, D.PRIVILLEGE_MEM, D.PRICE_OVER_WRITE, D.SALES_TAX_RATE, D.SALES_TAX_AMT, "				+ "D.MBR_AUTO_DISC " + "FROM SLSTXHDR H, SLSTXDET D "				+ "WHERE H.COY = D.COY " + "AND H.COY_SUB = D.COY_SUB "				+ "AND H.STORE = D.STORE "				+ "AND H.SALES_TRANS_DATE = D.SALES_TRANS_DATE "				+ "AND H.STORE_POS_NUMBER = D.STORE_POS_NUMBER "				+ "AND H.STORE_POS_TRANS = D.STORE_POS_TRANS "				+ "AND NOT EXISTS (SELECT 1 FROM PREBOOKDEP P "				+ "WHERE P.COY = D.COY " + "AND P.COY_SUB = D.COY_SUB "				+ "AND P.STORE = D.STORE "				+ "AND P.SALES_TRANS_DATE = D.SALES_TRANS_DATE "				+ "AND P.STORE_POS_NUMBER = D.STORE_POS_NUMBER "				+ "AND P.STORE_POS_TRANS = D.STORE_POS_TRANS "				+ "AND P.SALES_SEQ = D.SALES_SEQ " + ") " + "AND H.COY = ? "				+ "AND H.COY_SUB = ? " + "AND H.STORE = ? "				+ "AND H.SALES_TRANS_DATE = ? " + "AND H.STORE_POS_NUMBER = ? "				+ "AND H.STORE_POS_TRANS = ? ";		try {			pb_pstate = conn.prepareStatement(pb_query);			pb_pstate.setString(1, LAST_OPR);			pb_pstate.setString(2, LAST_OPR_FUNCT);			pb_pstate.setString(3, slstxhdrSQL.COY());			pb_pstate.setString(4, slstxhdrSQL.COY_SUB());			pb_pstate.setString(5, slstxhdrSQL.STORE());			pb_pstate.setDate(6, slstxhdrSQL.SALES_TRANS_DATE());			pb_pstate.setString(7, slstxhdrSQL.STORE_POS_NUMBER());			pb_pstate.setString(8, slstxhdrSQL.STORE_POS_TRANS());			pb_pstate.executeUpdate();		} catch (Exception e) {			e.printStackTrace();			throw (e);		} finally {			try {				if (pb_pstate != null)					pb_pstate.close();			} catch (Exception e) {			}			pb_pstate = null;		}	}	private void updatePREBOOKHDR(String strFlag) throws SQLException,			Exception {		int pb_count = 0;		prebookhdrSQL.setVObject((new PrebookhdrInfo()).getVObject()); // clear data		prebookhdrSQL.setCOY(slstxhdrSQL.COY());		prebookhdrSQL.setCOY_SUB(slstxhdrSQL.COY_SUB());		prebookhdrSQL.setSTORE(slstxhdrSQL.STORE());		prebookhdrSQL.setBOOK_NO(slstxhdrSQL.PRE_BOOK_NO());		pb_count = prebookhdrSQL.getBookNoForUpdate();		if (pb_count == 0) {			prebookhdrSQL.setPROCESS_ID(prebookhdrSQL.getPROCESS_ID(prebookhdrSQL.COY(), prebookhdrSQL.STORE(), LAST_OPR, LAST_OPR_FUNCT));			prebookhdrSQL.setBOOK_DATE(slstxhdrSQL.SALES_TRANS_DATE());			prebookhdrSQL.setCREATED_DATE(sysctlSQL.getLAST_DAY_UPDATEDPlusOne());			prebookhdrSQL.setCREATED_BY(SYSPrebookGenerator);			prebookhdrSQL.setCREATED_METHOD("U");		} else {			curr_prebookhdrSQL.setVObject((new PrebookhdrInfo()).getVObject()); // clear data			curr_prebookhdrSQL.setVObject((Vector) prebookhdrSQL.getVObject().clone()); // set current prebookhdr before update		}		if (strFlag != null && strFlag.equalsIgnoreCase("U")) {			prebookhdrSQL.setSTATUS("U"); // Updated status for confirm pre-booking sales (when customer pay full for booking item)			prebookhdrSQL.setUPDATED_DATE(slstxhdrSQL.SALES_TRANS_DATE());			prebookhdrSQL.setUPDATED_BY(slstxhdrSQL.CASHIER_ID());			prebookhdrSQL.setSTORE_POS_TRANS_2(slstxhdrSQL.STORE_POS_TRANS()); // keep receipt number for confirm pre-booking sales		} else {			prebookhdrSQL.setSTATUS("R"); // Updated status for cancel pre-booking sales (when customer refund)			prebookhdrSQL.setREFUND_DATE(slstxhdrSQL.SALES_TRANS_DATE());			prebookhdrSQL.setUPDATED_BY(slstxhdrSQL.CASHIER_ID());			prebookhdrSQL.setSTORE_POS_TRANS_3(slstxhdrSQL.STORE_POS_TRANS()); // keep receipt number for refund pre-booking sales		}		prebookhdrSQL.setLAST_OPR(LAST_OPR);		prebookhdrSQL.setLAST_OPR_FUNCT(LAST_OPR_FUNCT);		if (pb_count == 0) {			prebookhdrSQL.insert();		} else {			prebookhdrSQL.update();			prebookhdrlogger.logEditRecord(curr_prebookhdrSQL, prebookhdrSQL);		}	}	private void confirmPREBOOKSLS() throws SQLException, Exception {		PreparedStatement pbsls_pstate = null;		String pbsls_query = "UPDATE PREBOOKSLS P SET "				+ "UPDATE_STATUS = ? "				+ ",LAST_OPR = ? "				+ ",LAST_OPR_DATE = TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'),'YYYY-MM-DD') "				+ ",LAST_OPR_FUNCT = ? "				+ ",LAST_VERSION = To_Number(JLAST_VERSION()) "				+ "WHERE P.COY = ? " + "AND P.COY_SUB = ? "				+ "AND P.STORE = ? " + "AND P.BOOK_NO = ? "				+ "AND EXISTS (SELECT 1 FROM SLSTXHDR H, SLSTXDET D "				+ "WHERE H.COY = D.COY " + "AND H.COY_SUB = D.COY_SUB "				+ "AND H.STORE = D.STORE "				+ "AND H.SALES_TRANS_DATE = D.SALES_TRANS_DATE "				+ "AND H.STORE_POS_NUMBER = D.STORE_POS_NUMBER "				+ "AND H.STORE_POS_TRANS = D.STORE_POS_TRANS "				+ "AND H.COY = P.COY " + "AND H.COY_SUB = P.COY_SUB "				+ "AND H.STORE = P.STORE " + "AND H.PRE_BOOK_NO = P.BOOK_NO "				+ "AND D.SHORT_SKU = P.SHORT_SKU " + "AND H.COY = ? "				+ "AND H.COY_SUB = ? " + "AND H.STORE = ? "				+ "AND H.SALES_TRANS_DATE = ? " + "AND H.STORE_POS_NUMBER = ? "				+ "AND H.STORE_POS_TRANS = ? " + ") ";		try {			pbsls_pstate = conn.prepareStatement(pbsls_query);			pbsls_pstate.setString(1, "U");			pbsls_pstate.setString(2, LAST_OPR);			pbsls_pstate.setString(3, LAST_OPR_FUNCT);			pbsls_pstate.setString(4, slstxhdrSQL.COY());			pbsls_pstate.setString(5, slstxhdrSQL.COY_SUB());			pbsls_pstate.setString(6, slstxhdrSQL.STORE());			pbsls_pstate.setString(7, slstxhdrSQL.PRE_BOOK_NO());			pbsls_pstate.setString(8, slstxhdrSQL.COY());			pbsls_pstate.setString(9, slstxhdrSQL.COY_SUB());			pbsls_pstate.setString(10, slstxhdrSQL.STORE());			pbsls_pstate.setDate(11, slstxhdrSQL.SALES_TRANS_DATE());			pbsls_pstate.setString(12, slstxhdrSQL.STORE_POS_NUMBER());			pbsls_pstate.setString(13, slstxhdrSQL.STORE_POS_TRANS());			pbsls_pstate.executeUpdate();		} catch (Exception e) {			e.printStackTrace();			throw (e);		} finally {			try {				if (pbsls_pstate != null)					pbsls_pstate.close();			} catch (Exception e) {			}			pbsls_pstate = null;		}	}	private void refundPREBOOKSLS() throws SQLException, Exception {		PreparedStatement pbref_pstate = null;		String pbref_query = "UPDATE PREBOOKSLS P SET "				+ "UPDATE_STATUS = ? "				+ ",LAST_OPR = ? "				+ ",LAST_OPR_DATE = TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'),'YYYY-MM-DD') "				+ ",LAST_OPR_FUNCT = ? "				+ ",LAST_VERSION = To_Number(JLAST_VERSION()) "				+ "WHERE P.COY = ? " + "AND P.COY_SUB = ? "				+ "AND P.STORE = ? " + "AND P.BOOK_NO = ? ";		try {			pbref_pstate = conn.prepareStatement(pbref_query);			pbref_pstate.setString(1, "R");			pbref_pstate.setString(2, LAST_OPR);			pbref_pstate.setString(3, LAST_OPR_FUNCT);			pbref_pstate.setString(4, slstxhdrSQL.COY());			pbref_pstate.setString(5, slstxhdrSQL.COY_SUB());			pbref_pstate.setString(6, slstxhdrSQL.STORE());			pbref_pstate.setString(7, slstxhdrSQL.PRE_BOOK_NO());			pbref_pstate.executeUpdate();		} catch (Exception e) {			e.printStackTrace();			throw (e);		} finally {			try {				if (pbref_pstate != null)					pbref_pstate.close();			} catch (Exception e) {			}			pbref_pstate = null;		}	}	private void updatePREBOOKDEP(String strFlag) throws SQLException,			Exception {		PreparedStatement pbdep_pstate = null;		String pbdep_query = "UPDATE PREBOOKDEP P SET "				+ "UPDATE_STATUS = ? "				+ ",LAST_OPR = ? "				+ ",LAST_OPR_DATE = TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'),'YYYY-MM-DD') "				+ ",LAST_OPR_FUNCT = ? "				+ ",LAST_VERSION = To_Number(JLAST_VERSION()) "				+ "WHERE P.COY = ? " + "AND P.COY_SUB = ? "				+ "AND P.STORE = ? " + "AND P.BOOK_NO = ? "				+ "AND EXISTS (SELECT 1 FROM SLSTXHDR H, SLSTXDET D "				+ "WHERE H.COY = D.COY " + "AND H.COY_SUB = D.COY_SUB "				+ "AND H.STORE = D.STORE "				+ "AND H.SALES_TRANS_DATE = D.SALES_TRANS_DATE "				+ "AND H.STORE_POS_NUMBER = D.STORE_POS_NUMBER "				+ "AND H.STORE_POS_TRANS = D.STORE_POS_TRANS "				+ "AND H.COY = P.COY " + "AND H.COY_SUB = P.COY_SUB "				+ "AND H.STORE = P.STORE " + "AND H.PRE_BOOK_NO = P.BOOK_NO "				+ "AND D.SHORT_SKU = P.SHORT_SKU " + "AND H.COY = ? "				+ "AND H.COY_SUB = ? " + "AND H.STORE = ? "				+ "AND H.SALES_TRANS_DATE = ? " + "AND H.STORE_POS_NUMBER = ? "				+ "AND H.STORE_POS_TRANS = ? " + ") ";		try {			pbdep_pstate = conn.prepareStatement(pbdep_query);			pbdep_pstate.setString(1, strFlag);			pbdep_pstate.setString(2, LAST_OPR);			pbdep_pstate.setString(3, LAST_OPR_FUNCT);			pbdep_pstate.setString(4, slstxhdrSQL.COY());			pbdep_pstate.setString(5, slstxhdrSQL.COY_SUB());			pbdep_pstate.setString(6, slstxhdrSQL.STORE());			pbdep_pstate.setString(7, slstxhdrSQL.PRE_BOOK_NO());			pbdep_pstate.setString(8, slstxhdrSQL.COY());			pbdep_pstate.setString(9, slstxhdrSQL.COY_SUB());			pbdep_pstate.setString(10, slstxhdrSQL.STORE());			pbdep_pstate.setDate(11, slstxhdrSQL.SALES_TRANS_DATE());			pbdep_pstate.setString(12, slstxhdrSQL.STORE_POS_NUMBER());			pbdep_pstate.setString(13, slstxhdrSQL.STORE_POS_TRANS());			pbdep_pstate.executeUpdate();		} catch (Exception e) {			e.printStackTrace();			throw (e);		} finally {			try {				if (pbdep_pstate != null)					pbdep_pstate.close();			} catch (Exception e) {			}			pbdep_pstate = null;		}	}	private void insertPREBOOKSLS(FfSlsPosIntf _ffSlsPosTypeGRec)			throws SQLException, Exception {		int val_sign = 1; // positive = 1 or negative = -1		double d = 0;		isValidSku(_ffSlsPosTypeGRec.getString("PI_SKU")); // this is to get ITEMMST info only		prebookslsSQL.setVObject((new PrebookslsInfo()).getVObject()); // clear data		prebookslsSQL.setCOY(strmstSQL.STORE_COY());		prebookslsSQL.setCOY_SUB(strmstSQL.STORE_COY_SUB());		prebookslsSQL.setSTORE(strmstSQL.STORE());		prebookslsSQL.setSALES_TRANS_DATE(pos_sales_trans_date);		prebookslsSQL.setSTORE_POS_NUMBER(_ffSlsPosTypeGRec.getString("PI_POS"));		prebookslsSQL.setSTORE_POS_TRANS(_ffSlsPosTypeGRec.getString("PI_TRANS_NO"));		prebookslsSQL.setSALES_SEQ(++g_item_seq_no);		// already exist		if (slstxhdr_exist == true && prebookslsSQL.checkKeyExist() > 0) {			return;		}		prebookslsSQL.setBOOK_NO(slstxhdrSQL.PRE_BOOK_NO());		prebookslsSQL.setPOST_TRANS_DATE(posting_date);		prebookslsSQL.setSALES_TRANS_GROUP("S"); // default to "S"		if (_ffSlsPosTypeGRec.getString("PI_ATYPE").equals("0001")) {			prebookslsSQL.setSALES_TRANS_TYPE(TRNItemSales);			val_sign = 1;		} else if (_ffSlsPosTypeGRec.getString("PI_ATYPE").equals("0301")) {			prebookslsSQL.setSALES_TRANS_TYPE(TRNItemSalesRet);			// Aeon pos already provide the amount in -ve			// val_sign = -1;		}		prebookslsSQL.setITEM_GROUP(itemmstSQL.CLASS());		prebookslsSQL.setSHORT_SKU(itemmstSQL.ITEM_TKT_SKU());		prebookslsSQL.setQTY_SOLD(_ffSlsPosTypeGRec.getDouble("PI_QTY") * val_sign);		if (_ffSlsPosTypeGRec.getDouble("PI_QTY") == 0) {			prebookslsSQL.setUNIT_SELL(0);		} else {			// new rounding implementation lady			d = _ffSlsPosTypeGRec.getDouble("PI_ACTUAL_SELL") / _ffSlsPosTypeGRec.getDouble("PI_QTY");			d = qrRound.roundSell(d);			prebookslsSQL.setUNIT_SELL(d);		}		prebookslsSQL.setSALES_SELL_UNIT(itemmstSQL.ITEM_SELL_UNIT());		double unit_price = sellpriceReader.getSellprice(prebookslsSQL.SALES_TRANS_DATE(), strmstSQL.STORE(), itemmstSQL.ITEM_TKT_SKU());		double curr_retail = unit_price * prebookslsSQL.QTY_SOLD();		curr_retail = qrRound.roundSell(curr_retail);// new rounding implementation		if (itemmstSQL.ITEM_WEIGH_CD().equals("Y")) {			curr_retail = _ffSlsPosTypeGRec.getDouble("PI_REG_SELL") * val_sign;		}		prebookslsSQL.setCURRENT_RETAIL(curr_retail);		if (itemmstSQL.ITEM_WEIGH_CD().equals("Y")) {			prebookslsSQL.setEXT_SELL(_ffSlsPosTypeGRec.getDouble("PI_REG_SELL") * val_sign);		} else {			prebookslsSQL.setEXT_SELL(_ffSlsPosTypeGRec.getDouble("PI_REG_SELL") * val_sign * prebookslsSQL.QTY_SOLD());		}		prebookslsSQL.setEXT_NET_SALES(_ffSlsPosTypeGRec.getDouble("PI_ACTUAL_SELL") * val_sign);		prebookslsSQL.setMEMBER_DISC(_ffSlsPosTypeGRec.getDouble("PI_DISC2_AMT") * val_sign);		prebookslsSQL.setOTHER_DISC1(_ffSlsPosTypeGRec.getDouble("PI_DISC3_AMT") * val_sign);		prebookslsSQL.setEXEC_DISC(_ffSlsPosTypeGRec.getDouble("PI_DISC4_AMT") * val_sign);		prebookslsSQL.setPOS_DISC(_ffSlsPosTypeGRec.getDouble("PI_DISC5_AMT") * val_sign);		prebookslsSQL.setSTAFF_DISC(_ffSlsPosTypeGRec.getDouble("PI_DISC6_AMT") * val_sign);		prebookslsSQL.setOTHER_DISC2(_ffSlsPosTypeGRec.getDouble("PI_DISC7_AMT") * val_sign);		prebookslsSQL.setGROUP_DISC(_ffSlsPosTypeGRec.getDouble("PI_DISC8_AMT") * val_sign);		prebookslsSQL.setSTDD_DISC(_ffSlsPosTypeGRec.getDouble("PI_DISC9_AMT") * val_sign);		prebookslsSQL.setPROMO_DISC(_ffSlsPosTypeGRec.getDouble("PI_DISC10_AMT") * val_sign);		prebookslsSQL.setMFR_DISC(_ffSlsPosTypeGRec.getDouble("PI_DISC11_AMT") * val_sign);		prebookslsSQL.setMBR_AUTO_DISC(_ffSlsPosTypeGRec.getDouble("PI_DISC13_AMT") * val_sign);		prebookslsSQL.setPRCCHG_PROMO_DISC(_ffSlsPosTypeGRec.getLong("PI_PRCCHG_NO") * val_sign);		prebookslsSQL.setPRCCHG_MEMBER_DISC(_ffSlsPosTypeGRec.getLong("PI_PRCCHG1_NO") * val_sign);		prebookslsSQL.setPRCCHG_MIX_MATCH_DISC(_ffSlsPosTypeGRec.getLong("PI_PRCCHG2_NO") * val_sign);		prebookslsSQL.setPRCCHG_GROUP_DISC(_ffSlsPosTypeGRec.getLong("PI_PRCCHG3_NO") * val_sign);		if (_ffSlsPosTypeGRec.getString("PI_GST_CODE") == null				|| _ffSlsPosTypeGRec.getString("PI_GST_CODE").trim().length() == 0) {			prebookslsSQL.setSALES_VAT_CODE(itemmstSQL.ITEM_SELL_VAT_CODE());		} else {			prebookslsSQL.setSALES_VAT_CODE(_ffSlsPosTypeGRec.getString("PI_GST_CODE"));		}		if (_ffSlsPosTypeGRec.getString("PI_GST_RATE") == null				|| _ffSlsPosTypeGRec.getString("PI_GST_RATE").trim().length() == 0) {			prebookslsSQL.setSALES_VAT_RATE(itemmstSQL.GST_SELL_RATE());		} else {			prebookslsSQL.setSALES_VAT_RATE(Double.parseDouble(_ffSlsPosTypeGRec.getString("PI_GST_RATE")));		}		prebookslsSQL.setSALES_VAT_AMOUNT(_ffSlsPosTypeGRec.getDouble("PI_GST_AMT"));		prebookslsSQL.setUPDATE_FLAG(IF_Slstxdet.UPDATE_FLAGoUpload); // the sales data is uploaded from pos system		prebookslsSQL.setUPDATE_STATUS(prebookhdrSQL.STATUS()); // G type record status will be set follow Pre-Book Header status		prebookslsSQL.setAUTHORISE_DISC(calcGTypeAuthoriseDisc(prebookslsSQL));		prebookslsSQL.setEXT_DISC_AMOUNT(calcGTypeEXT_DISC_AMOUNT(prebookslsSQL));		double total_disc_wo_tax = prebookslsSQL.EXT_DISC_AMOUNT() * (100 / (100 + prebookslsSQL.SALES_VAT_RATE()));		total_disc_wo_tax = qrRound.roundDisc(total_disc_wo_tax);		prebookslsSQL.setEXT_DISC_VAT(prebookslsSQL.EXT_DISC_AMOUNT() - total_disc_wo_tax);		prebookslsSQL.setLAST_OPR(LAST_OPR);		prebookslsSQL.setLAST_OPR_FUNCT(LAST_OPR_FUNCT);		prebookslsSQL.insert();	}	private double calcGTypeAuthoriseDisc(PrebookslsSQL _prebooksls)			throws SQLException {		if (classmstSQL.CLASS().equals(itemmstSQL.CLASS()) == false) {			classmstSQL.setCLASS(itemmstSQL.CLASS());			if (classmstSQL.getByKey() == 0) {				this.writeln("Classmst record does not exist. CLASS=" + classmstSQL.CLASS());			}		}		if (!sbclsmstSQL.SUBCLASS().equals(itemmstSQL.SUBCLASS())) {			sbclsmstSQL.setSUBCLASS(itemmstSQL.SUBCLASS());			if (sbclsmstSQL.getByKey() == 0) {				this.writeln("Sbclsmst record does not exist. SUBCLASS=" + sbclsmstSQL.SUBCLASS());			}		}		if (classmstSQL.CCESS_CSIGN_CLASS().equals("D") == false				|| sbclsmstSQL.AUTO_PA().equals("Y") == false) {			return 0;		}		if (classmstSQL.COST_CLASS().equals("Y")				|| itemmstSQL.ITEM_WEIGH_CD().equals("Y")) {			return 0;		}		double total_disc = _prebooksls.PROMO_DISC() + _prebooksls.STAFF_DISC()				+ _prebooksls.MEMBER_DISC() + _prebooksls.POS_DISC()				+ _prebooksls.OTHER_DISC1() + _prebooksls.OTHER_DISC2()				+ _prebooksls.OTHER_DISC3() + _prebooksls.EXEC_DISC()				+ _prebooksls.CARD_DISC() + _prebooksls.GROUP_DISC()				+ _prebooksls.STDD_DISC() + _prebooksls.MFR_DISC()				+ _prebooksls.MBR_AUTO_DISC();		double auth_disc = _prebooksls.CURRENT_RETAIL() - (_prebooksls.EXT_NET_SALES() + total_disc);		return auth_disc;	}	private double calcGTypeEXT_DISC_AMOUNT(PrebookslsSQL _prebooksls) {		return (_prebooksls.PROMO_DISC() + _prebooksls.STAFF_DISC()				+ _prebooksls.MEMBER_DISC() + _prebooksls.POS_DISC()				+ _prebooksls.OTHER_DISC1() + _prebooksls.OTHER_DISC2()				+ _prebooksls.OTHER_DISC3() + _prebooksls.GROUP_DISC()				+ _prebooksls.AUTHORISE_DISC() + _prebooksls.EXEC_DISC()				+ _prebooksls.CARD_DISC() + _prebooksls.STDD_DISC()				+ _prebooksls.MFR_DISC() + _prebooksls.MBR_AUTO_DISC());	}	// Goxz 20170803 Pre-Booking}